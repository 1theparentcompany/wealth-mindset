<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reader - Wealth & Mindset</title>
    <link rel="stylesheet" href="css/style.css">

    <!-- Supabase & Utils -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="js/image-utils.js"></script>
    <script src="js/popup.js" defer></script>

    <style>
        /* [Previous CSS Content - Preserved] */
        :root {
            --sidebar-width: 320px;
            --header-height: 70px;
        }

        .reader-container {
            width: 100%;
            max-width: 100%;
            margin: 40px auto;
            padding: 0 40px;
            position: relative;
        }

        .reader-content {
            font-size: clamp(1rem, 1.2vw, 1.25rem);
            line-height: 1.8;
            color: var(--color-text);
            font-family: var(--font-reading);
            max-width: 720px;
            margin: 0 auto;
            /* Safety: Ensure text is visible */
            opacity: 1;
            visibility: visible;
        }

        .reader-content p {
            margin-bottom: 2rem;
            text-align: left;
        }

        .reader-header {
            text-align: left;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--color-border);
            max-width: 720px;
            margin-left: auto;
            margin-right: auto;
        }

        .reader-book-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--color-accent);
            margin-bottom: 10px;
            font-weight: 700;
        }

        .reader-chapter-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--color-heading);
            font-family: var(--font-heading);
            margin: 0;
            line-height: 1.2;
        }

        /* Sidebars */
        .page-container {
            display: flex;
            gap: 40px;
            width: 100%;
            max-width: 100%;
            margin: 40px auto;
            padding: 0 40px;
            justify-content: center;
        }

        .side-sidebar {
            width: 300px;
            flex-shrink: 0;
            display: none;
            /* Hidden on small screens */
        }

        .main-layout-content {
            flex: 1;
            width: 100%;
        }

        @media (min-width: 1400px) {
            .side-sidebar {
                display: block;
            }
        }

        .sticky-ads {
            position: sticky;
            top: 100px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .vertical-ad-banner {
            width: 100%;
            height: 600px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px dashed rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.3);
        }

        .ad-container.ad-middle {
            max-width: 720px;
            margin: 40px auto;
        }

        /* Chapter List Sidebar */
        .chapter-list-sidebar {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .sidebar-title {
            display: block;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--color-text);
            opacity: 0.5;
            margin-bottom: 15px;
            font-weight: 800;
            letter-spacing: 1px;
        }

        .sidebar-link {
            display: block;
            padding: 10px 14px;
            color: var(--color-text);
            text-decoration: none;
            font-size: 0.9rem;
            border-radius: 8px;
            margin-bottom: 4px;
            transition: all 0.2s;
            border-left: 2px solid transparent;
        }

        .sidebar-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            transform: translateX(5px);
        }

        .sidebar-link.active {
            background: var(--color-accent);
            color: white !important;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.15);
        }

        /* Navigation & Interactions */
        .chapter-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 60px;
            padding-top: 40px;
            border-top: 1px solid var(--color-border);
        }

        .nav-link {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-decoration: none;
            transition: transform 0.3s;
        }

        .nav-link:hover {
            transform: translateY(-3px);
        }

        .nav-link.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .nav-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--color-text);
            opacity: 0.5;
            letter-spacing: 1px;
        }

        .nav-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-heading);
            font-family: var(--font-heading);
        }

        .reader-nav-interactions {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            background: var(--color-secondary-bg);
            backdrop-filter: blur(var(--glass-blur));
            border-radius: 100px;
            border: 1px solid var(--color-border);
        }

        .interaction-btn {
            background: transparent;
            border: none;
            color: var(--color-text);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 42px;
            height: 42px;
            padding: 0 12px;
            border-radius: 21px;
        }

        .interaction-btn:hover,
        .interaction-btn.active {
            color: var(--color-accent);
            background: var(--color-accent-glow);
        }

        .interaction-btn svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
        }

        .interaction-btn.active svg {
            fill: currentColor;
        }

        /* Custom Backgrounds */
        body.has-custom-bg {
            background-color: #020617;
            position: relative;
            min-height: 100vh;
            /* Default for custom bg is dark mode, but we override it per-theme below */
            --color-text: #e2e8f0;
            --color-heading: #ffffff;
            --color-border: rgba(255, 255, 255, 0.1);
        }

        /* Essential visibility fix for light mode with custom background */
        .reader-container {
            color: var(--color-text);
            transition: color 0.3s ease;
        }

        body.has-custom-bg .reader-container {
            --color-text: #1e293b;
            --color-heading: #0f172a;
            --color-border: rgba(0, 0, 0, 0.1);
        }

        /* Specifically force h1, h2, h3 colors inside reader and header */
        .reader-container h1,
        .reader-container h2,
        .reader-container h3,
        .reader-header h1,
        .reader-content h1,
        .reader-content h2,
        .reader-content h3 {
            color: var(--color-heading) !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        .dark-mode.has-custom-bg .reader-container,
        .dark-mode .reader-container {
            --color-text: #94a3b8;
            --color-heading: #ffffff;
            --color-border: rgba(255, 255, 255, 0.1);
        }

        /* Ensure banner text is readable */
        #book-title-main,
        #reading-ch-label {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body.has-custom-bg #book-title-main,
        body.has-custom-bg #reading-ch-label {
            color: #ffffff;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 0, 0, 0.2);
        }

        .dark-mode.has-custom-bg #book-title-main {
            color: #ffffff;
        }

        body.has-custom-bg::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--custom-bg-url);
            background-size: var(--custom-bg-size, cover);
            background-position: center;
            background-attachment: fixed;
            z-index: -2;
            filter: brightness(1.2) saturate(1.2);
            pointer-events: none;
        }

        body.has-custom-bg::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--custom-bg-overlay);
            z-index: -1;
            pointer-events: none;
        }

        body.has-custom-bg {
            --custom-bg-overlay: linear-gradient(to bottom, rgba(6, 11, 25, 0.4), rgba(6, 11, 25, 0.7));
        }

        .reader-container.has-custom-bg {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border-radius: 32px;
            padding: 80px 60px;
            border: 1px solid var(--glass-border);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--color-secondary-bg);
            border: 1px solid var(--color-border);
            border-radius: 24px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 11000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            color: white;
            padding: 16px 32px;
            border-radius: 100px;
            font-weight: 700;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Music Control */
        .music-control {
            position: fixed;
            bottom: 40px;
            right: 40px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 100px;
            border: 1px solid var(--glass-border);
            color: var(--color-text);
            cursor: pointer;
        }

        .music-control.playing .icon {
            animation: pulse-music 2s infinite;
            background: var(--color-accent);
            color: white;
        }

        .music-control .icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
        }

        @keyframes pulse-music {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(37, 99, 235, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
            }
        }

        .reader-content blockquote {
            margin: 2.5rem 0;
            padding: 2rem;
            background: var(--color-secondary-bg);
            border-left: 5px solid var(--color-accent);
            border-radius: 0 20px 20px 0;
            font-family: var(--font-heading);
            font-size: 1.4rem;
            line-height: 1.4;
            font-weight: 700;
            color: var(--color-heading);
            font-style: italic;
            position: relative;
        }

        .reader-content blockquote::before {
            content: '"';
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 4rem;
            opacity: 0.1;
            color: var(--color-accent);
            line-height: 1;
        }

        /* Language Expander */
        .lang-expand-options {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            min-width: 180px;
            background: var(--color-secondary-bg);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 6px;
            z-index: 100;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<script>
    (function () {
        const t = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        if (t === 'dark') document.documentElement.classList.add('dark-mode');
    })();
</script>

<body class="reader-page">
    <header class="site-header">
        <div
            style="max-width: var(--max-width); width: 100%; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 var(--spacing-unit);">
            <div class="logo"><a href="index.html"><img src="assets/logo-new.png" alt="Wealth & Mindset"
                        class="logo-img"><span>Wealth & Mindset</span></a></div>
            <nav>
                <a href="index.html">Home</a>
                <a href="books.html">Library</a>
                <a href="about.html">About</a>
                <a href="contact.html">Contact</a>
                <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">üåô</button>
                <button class="mobile-menu-toggle" id="mobile-menu-btn">‚ãÆ</button>
            </nav>
        </div>
    </header>
    <div class="progress-container">
        <div class="progress-bar" id="reading-progress"></div>
    </div>

    <div class="menu-backdrop" id="menu-backdrop"></div>
    <div class="mobile-menu-overlay" id="mobile-menu-overlay">
        <div class="mobile-menu-header"><button class="close-mobile-menu" id="close-mobile-menu">√ó</button></div>
        <nav class="mobile-nav-links">
            <a href="index.html">Home</a><a href="books.html">Library</a><a href="about.html">About</a><a
                href="contact.html">Contact</a>
        </nav>
    </div>

    <audio id="bg-music" loop preload="auto">
        <!-- <source src="https://www.soundjay.com/nature/rain-07.mp3" type="audio/mpeg"> -->
    </audio>
    <button class="music-control" id="music-toggle" onclick="toggleMusic()">
        <span class="music-status-text">Rain Ambient</span>
        <div class="icon">üåßÔ∏è</div>
    </button>

    <main>
        <section class="book-banner-top" style="max-width: 100%; margin: 0 auto; padding: 40px var(--spacing-unit) 0;">
            <div
                style="display: flex; justify-content: space-between; align-items: flex-end; gap: 40px; margin-bottom: 30px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; opacity: 0.7;">
                        <img src="assets/logo-new.png" style="height: 20px; border-radius: 4px;">
                        <span
                            style="font-weight: 700; text-transform: uppercase; letter-spacing: 2px; font-size: 0.75rem; color: var(--color-accent);">Premium
                            Reading</span>
                    </div>
                    <h1 id="book-title-main"
                        style="font-size: var(--font-size-h2); font-weight: 800; color: var(--color-heading); margin: 0; font-family: var(--font-heading); transition: color 0.3s ease;">
                        Book Title</h1>
                </div>
            </div>
        </section>

        <section class="reader-controls"
            style="max-width: var(--max-width); margin: 0 auto; padding: 0 var(--spacing-unit);">
            <div class="top-interactions-wrapper"
                style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 40px;">
                <!-- Row 1: Interactions -->
                <div class="reader-nav-interactions action-bar-row" style="align-self: flex-start;">
                    <button class="interaction-btn" id="btn-like-top" onclick="toggleChapterLike()" title="Like"><svg
                            viewBox="0 0 24 24">
                            <path
                                d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" />
                        </svg><span class="count" id="count-like-top">0</span></button>
                    <button class="interaction-btn" id="btn-dislike-top" onclick="toggleChapterDislike()"
                        title="Dislike"><svg viewBox="0 0 24 24">
                            <path
                                d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.37-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z" />
                        </svg><span class="count" id="count-dislike-top">0</span></button>
                    <button class="interaction-btn" id="btn-comment-top" onclick="jumpToCommentsReader()"
                        title="Comment"><svg viewBox="0 0 24 24">
                            <path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z" />
                        </svg></button>
                    <button class="interaction-btn" id="btn-save-top" onclick="toggleSaveReader()" title="Save"><svg
                            viewBox="0 0 24 24">
                            <path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z" />
                        </svg></button>
                    <button class="interaction-btn" id="btn-share-top" onclick="shareBookReader()" title="Share"><svg
                            viewBox="0 0 24 24">
                            <path
                                d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z" />
                        </svg></button>
                </div>

                <!-- Row 2: Language Selector -->
                <div id="top-lang-selector-container" style="align-self: flex-start;"></div>

                <!-- Row 3: Report & Original -->
                <div class="action-bar-row" style="display: flex; gap: 15px; align-self: flex-start;">
                    <button class="interaction-btn" id="btn-report-top" onclick="toggleReportReader()" title="Report"
                        style="width: auto; height: auto; padding: 10px 18px; border-radius: 12px; background: var(--color-secondary-bg); border: 1px solid var(--color-border);">
                        <svg viewBox="0 0 24 24" style="margin-right: 8px;">
                            <path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" fill="currentColor" />
                        </svg>
                        <span class="count">Report</span>
                    </button>
                    <button class="interaction-btn" id="btn-original-top" onclick="openOriginalContent()"
                        title="Original Text"
                        style="width: auto; height: auto; padding: 10px 18px; border-radius: 12px; background: var(--color-secondary-bg); border: 1px solid var(--color-border);">
                        <svg viewBox="0 0 24 24" style="margin-right: 8px;">
                            <path
                                d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"
                                fill="currentColor" />
                        </svg>
                        <span class="count">Original Content</span>
                    </button>
                    <button class="interaction-btn" id="btn-reading-mode" onclick="toggleReadingMode()"
                        title="Reading Mode"
                        style="width: auto; height: auto; padding: 10px 18px; border-radius: 12px; background: rgba(37, 99, 235, 0.1); border: 1px solid var(--color-border); color: var(--color-accent);">
                        <span style="margin-right: 8px;">üìñ</span>
                        <span class="count">Reading Mode</span>
                    </button>
                </div>
            </div>

            <div class="chapters-tabs-outer"
                style="overflow-x: auto; margin-bottom: 40px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div class="chapters-tabs-container" id="chapters-tabs-container"
                    style="display: flex; justify-content: flex-start; min-width: max-content;"></div>
            </div>
        </section>

        <div class="page-container" style="margin-top: 0;">
            <aside class="side-sidebar left">
                <div class="sticky-ads">
                    <div class="chapter-list-sidebar" id="sidebar-chapters">
                        <span class="sidebar-title">Book Category: All Book</span>
                    </div>
                </div>
            </aside>

            <div class="main-layout-content">
                <div class="reader-container" style="margin-top: 40px;">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 2px solid var(--color-border); margin-bottom: 50px;">
                        <div><a href="javascript:history.back()"
                                style="text-decoration: none; font-size: 0.95rem; color: var(--color-text); font-weight: 700;"><span>‚ùÆ</span>
                                BACK</a></div>
                        <div style="display: flex; gap: 12px;">
                            <a href="#" id="prev-btn-top" class="glass"
                                style="padding: 10px 24px; border-radius: 100px; font-weight: 700; color: var(--color-text);">‚ùÆ
                                PREV</a>
                            <a href="#" id="next-btn-top" class="glass"
                                style="padding: 10px 24px; border-radius: 100px; font-weight: 700; color: #fff; background: var(--color-accent);">NEXT
                                ‚ùØ</a>
                        </div>
                    </div>

                    <header class="reader-header" style="border: none; text-align: left; padding-bottom: 0;">
                        <span id="reading-ch-label" class="reader-book-title">Chapter --</span>
                        <div id="lang-selector-container"></div>
                        <h1 class="reader-chapter-title" id="chapter-title-display">Chapter Title</h1>
                    </header>

                    <article class="reader-content" id="reader-content-display"></article>

                    <nav class="chapter-navigation">
                        <a href="#" class="nav-link" id="prev-chapter"><span class="nav-label">Previous
                                Chapter</span><span class="nav-title" id="prev-title">---</span></a>
                        <div class="reader-nav-interactions">
                            <button class="interaction-btn" id="btn-like-bottom" onclick="toggleChapterLike()"><svg
                                    viewBox="0 0 24 24">
                                    <path
                                        d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" />
                                </svg><span class="count" id="count-like-bottom">0</span></button>
                            <button class="interaction-btn" id="btn-dislike-bottom"
                                onclick="toggleChapterDislike()"><svg viewBox="0 0 24 24">
                                    <path
                                        d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.37-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z" />
                                </svg><span class="count" id="count-dislike-bottom">0</span></button>
                            <button class="interaction-btn" id="btn-comment-bottom"
                                onclick="jumpToCommentsReader()"><svg viewBox="0 0 24 24">
                                    <path
                                        d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z" />
                                </svg></button>
                            <button class="interaction-btn" id="btn-save-bottom" onclick="toggleSaveReader()"><svg
                                    viewBox="0 0 24 24">
                                    <path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z" />
                                </svg></button>
                        </div>
                        <a href="#" class="nav-link" id="next-chapter" style="text-align: right;"><span
                                class="nav-label">Up Next</span><span class="nav-title" id="next-title">---</span></a>
                    </nav>
                </div>
            </div>

            <aside class="side-sidebar right">
                <div class="sticky-ads">
                    <div class="ad-container ad-wide glass" style="width: 300px; height: 600px;">
                        <div style="font-weight: 800; color: var(--color-heading);">[ Premium Slot ]</div>
                        <div style="font-size: 0.7rem; opacity: 0.5;">300 x 600 - Vertical</div>
                    </div>
                    <div class="ad-container glass"
                        style="width: 100%; height: 250px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 16px; background: var(--glass-bg); border: 1px solid var(--glass-border);">
                        <div style="font-weight: 800; color: var(--color-heading);">[ Premium Slot ]</div>
                        <div style="font-size: 0.7rem; opacity: 0.5;">300 x 250 - Sidebar</div>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <!-- Modals -->
    <div id="chapter-review-modal" class="modal">
        <div class="modal-content glass">
            <h3>üìù Review Chapter</h3>
            <p>Share your thoughts about <span id="chapter-review-title"></span></p>
            <input type="text" id="chapter-review-name" placeholder="Name"
                style="width: 100%; padding: 12px; margin-bottom: 20px;">
            <div id="chapter-rating-stars"
                style="display: flex; gap: 10px; font-size: 2rem; margin-bottom: 20px; cursor: pointer;">
                <span class="star-box" onclick="setChapterRating(1)">‚òÖ</span><span class="star-box"
                    onclick="setChapterRating(2)">‚òÖ</span><span class="star-box"
                    onclick="setChapterRating(3)">‚òÖ</span><span class="star-box"
                    onclick="setChapterRating(4)">‚òÖ</span><span class="star-box" onclick="setChapterRating(5)">‚òÖ</span>
            </div>
            <textarea id="chapter-review-comment" placeholder="Review..."
                style="width: 100%; height: 100px; padding: 12px; margin-bottom: 20px;"></textarea>
            <button onclick="submitChapterReview()"
                style="padding: 12px 24px; background: var(--color-accent); border: none; color: white; border-radius: 8px;">Submit</button>
            <button onclick="closeChapterReviewModal()"
                style="padding: 12px 24px; background: transparent; border: 1px solid #ccc; color: white; border-radius: 8px;">Cancel</button>
        </div>
    </div>

    <div id="chapter-browser-modal" class="modal">
        <div class="modal-content" style="max-height: 80vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">Browse Chapters</h3>
                <button onclick="closeChapterModal()"
                    style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">√ó</button>
            </div>
            <div id="chapter-browser-list"
                style="overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 8px;"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/modal-utils.js"></script>
    <script src="js/script.js"></script>
    <script src="js/cache-utils.js"></script>

    <script>
        // --- Utils ---
        function esc(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- Language Selector ---
        // --- Language Selector ---
        function getLangNameFull(code) {
            const map = {
                'en': 'English', 'es': 'Spanish', 'fr': 'French', 'hi': 'Hindi',
                'de': 'German', 'zh': 'Chinese', 'ja': 'Japanese', 'ru': 'Russian',
                'pt': 'Portuguese', 'it': 'Italian'
            };
            return map[code] || code.toUpperCase();
        }

        window.renderLanguageSelector = async function (book) {
            const containers = [
                document.getElementById('lang-selector-container'),
                document.getElementById('top-lang-selector-container')
            ].filter(el => el !== null);

            if (!book || containers.length === 0) return;

            let currentBook = book;
            let familyId = currentBook.original_book_id || currentBook.id;
            let variants = [currentBook];
            const hasSupabase = typeof isSupabaseConfigured === 'function' && isSupabaseConfigured();

            if (hasSupabase) {
                try {
                    // Fetch variants
                    const { data: familyBooks } = await supabaseClient.from('books')
                        .select('id, title, language, original_book_id')
                        .or(`id.eq.${familyId},original_book_id.eq.${familyId}`);

                    if (familyBooks && familyBooks.length > 0) variants = familyBooks;
                } catch (e) { console.warn("Lang fetch error", e); }
            }

            const uniqueVariants = Array.from(new Map(variants.map(item => [item.language || 'en', item])).values());
            if (uniqueVariants.length <= 1) return;

            containers.forEach((container, idx) => {
                const instanceId = `lang-inst-${idx}`;
                const rawLang = currentBook.language || 'en';
                const currentLangName = getLangNameFull(rawLang);

                const optionsHtml = uniqueVariants.map(v => {
                    const isCurrent = v.id === currentBook.id;
                    const langName = getLangNameFull(v.language || 'en');
                    return `
                        <div class="lang-opt ${isCurrent ? 'active' : ''}" onclick="switchReaderLanguage('${v.id}')"
                             style="padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: ${isCurrent ? 'var(--color-accent)' : 'var(--color-text)'};">
                            <span>${langName}</span> ${isCurrent ? '‚úì' : ''}
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div class="lang-expand-container" style="position: relative; display: inline-block;">
                        <button class="lang-expand-trigger" onclick="toggleLangOptions(event, '${instanceId}')"
                                style="background: var(--color-secondary-bg); border: 1px solid var(--color-border); color: var(--color-text); opacity: 0.8; padding: 10px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 500;">
                            <span style="opacity: 0.6; font-size: 0.9em;">Language:</span>
                            <span style="color: var(--color-heading); font-weight: 700;">${currentLangName}</span>
                            <span style="opacity: 0.6; font-size: 0.8em;">‚ñº</span>
                        </button>
                        <div id="${instanceId}-options" class="lang-expand-options" style="display: none;">${optionsHtml}</div>
                    </div>
                `;
            });
        };

        function toggleLangOptions(e, id) {
            e.stopPropagation();
            const el = document.getElementById(`${id}-options`);
            if (el) el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        function switchReaderLanguage(newId) {
            const urlParams = new URLSearchParams(window.location.search);
            const ch = urlParams.get('ch') || '0';
            window.location.href = `reader.html?id=${newId}&ch=${ch}`;
        }

        // --- Engagement Logic ---
        window.onscroll = function () {
            let winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            let height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            let scrolled = (winScroll / height) * 100;
            const bar = document.getElementById("reading-progress");
            if (bar) bar.style.width = scrolled + "%";
        };

        function toggleReadingMode() {
            const isReadingMode = document.body.classList.toggle('reading-mode');
            localStorage.setItem('reading_mode', isReadingMode);

            const header = document.querySelector('.site-header');
            const btns = document.querySelectorAll('.action-bar-row, .top-interactions-wrapper');

            if (isReadingMode) {
                if (header) header.style.display = 'none';
                document.documentElement.style.fontSize = '1.1em';
            } else {
                if (header) header.style.display = 'block';
                document.documentElement.style.fontSize = '';
            }

            const btn = document.getElementById('btn-reading-mode');
            if (btn) {
                if (isReadingMode) {
                    btn.style.background = 'var(--color-accent)';
                    btn.style.color = 'white';
                    btn.innerHTML = '<span>‚òÄÔ∏è</span> <span class="count">Exit Reading Mode</span>';
                } else {
                    btn.style.background = 'rgba(37, 99, 235, 0.1)';
                    btn.style.color = 'var(--color-accent)';
                    btn.innerHTML = '<span>üìñ</span> <span class="count">Reading Mode</span>';
                }
            }
        }

        // Init reading mode if saved
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('reading_mode') === 'true') {
                toggleReadingMode();
            }
        });

        window.onclick = function (event) {
            if (!event.target.closest('.lang-expand-container')) {
                document.querySelectorAll('.lang-expand-options').forEach(el => el.style.display = 'none');
            }
        }

        // --- Core Reader Logic ---
        const CHAPTERS_CACHE_KEY = "chapters_cache";

        window.renderChapter = function (chapter, book, chapterIndex) {
            if (!chapter || !book) return;

            const bookId = book.id;
            document.title = `${chapter.title || 'Chapter ' + (chapterIndex + 1)} - ${book.title}`;
            document.getElementById('book-title-main').textContent = book.title;

            if (typeof window.renderLanguageSelector === 'function') window.renderLanguageSelector(book);

            // Visuals
            const bgUrl = chapter.backgroundImage || chapter.background_image;
            if (bgUrl) {
                document.body.style.setProperty('--custom-bg-url', `url('${window.getSupabaseImageUrl(bgUrl)}')`);
                document.body.classList.add('has-custom-bg');
            }

            // Audio
            const audioEl = document.getElementById('bg-music');
            if (audioEl && (chapter.musicUrl || chapter.audio_url)) {
                audioEl.src = chapter.musicUrl || chapter.audio_url;
                audioEl.volume = 0.3;
            }

            // Text
            let chNoLabel = `Chapter ${chapterIndex + 1}`;
            let chTitle = chapter.title;
            if (chapter.title.includes(':')) {
                const parts = chapter.title.split(':');
                chNoLabel = parts[0].trim();
                chTitle = parts[1].trim();
            }
            document.getElementById('reading-ch-label').textContent = chNoLabel;
            document.getElementById('chapter-title-display').textContent = chTitle;

            // Content
            const contentDisplay = document.getElementById('reader-content-display');
            let content = chapter.content || "";
            if (window.fixSupabaseImagesInHtml) content = window.fixSupabaseImagesInHtml(content);

            if (!/<[a-z][\s\S]*>/i.test(content)) {
                // Enhanced Markdown Parser - Robust against whitespace and carriage returns
                content = content
                    .replace(/\r/g, '') // Normalize line endings
                    .replace(/^#{1,3}\s+(.+)$/gm, (match, title) => {
                        const level = match.trim().split(' ')[0].length;
                        return `<h${level}>${title.trim()}</h${level}>`;
                    })
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');

                content = content.split('\n').map((line, idx) => {
                    const cleanLine = line.trim();
                    if (!cleanLine) return '<br>';
                    // If it's already a tag, leave it
                    if (/^<[a-z]/i.test(cleanLine)) return cleanLine;

                    if (cleanLine.startsWith('>')) {
                        return `<blockquote>${cleanLine.substring(1).trim()}</blockquote>`;
                    }
                    if (idx === 0) return `<p class="intro">${cleanLine}</p>`;
                    return `<p>${cleanLine}</p>`;
                }).join('');
            } else {
                // If it's HTML, try to add intro class to first p if not present
                content = content.replace(/<p>/, '<p class="intro">');
            }

            // Inject Inline Micro-Breaks every 4 paragraphs
            const paragraphs = content.match(/<p[\s\S]*?<\/p>/g) || [];
            if (paragraphs.length > 5) {
                for (let i = 4; i < paragraphs.length; i += 5) {
                    const isReflect = (i / 5) % 2 === 0;
                    const breakHtml = isReflect
                        ? `<div class="inline-break reflect"><span class="break-tag">üß† Pause & Reflect</span>"How does this principle apply to your current situation?"</div>`
                        : `<div class="inline-break"><span class="break-tag">üí° Key Idea</span>Focus on the consistency of your actions, not just the magnitude of your goals.</div>`;
                    paragraphs[i] = breakHtml + paragraphs[i];
                }
                content = paragraphs.join('');
            }

            // Inject Smart Ad Placeholders
            const adPlaceholder = (label) => `
                <div class="ad-container" style="margin: 40px auto; padding: 20px; background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.1); border-radius: 12px; text-align: center;">
                    <span style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px;">Advertisement - ${label}</span>
                    <div style="height: 100px; display: flex; align-items: center; justify-content: center; color: #475569;">[ Ad Slot ]</div>
                </div>
            `;

            // Re-split content to inject ads at natural breaks
            const finalParagraphs = content.match(/<p[\s\S]*?<\/p>|<div[\s\S]*?<\/div>|<h2[\s\S]*?<\/h2>|<blockquote[\s\S]*?<\/blockquote>/g) || [];
            if (finalParagraphs.length > 3) {
                // Top Ad: After the first paragraph (Intro)
                finalParagraphs.splice(1, 0, adPlaceholder('Top'));

                // Middle Ad: Roughly halfway if long enough
                if (finalParagraphs.length > 10) {
                    const midIndex = Math.floor(finalParagraphs.length / 2);
                    finalParagraphs.splice(midIndex, 0, adPlaceholder('Middle'));
                }
                content = finalParagraphs.join('');
            }
            content += adPlaceholder('Bottom');

            // Inject Continuation Loop at the end
            const nextCh = book.chapters[chapterIndex + 1];
            const continuationHtml = `
                <div class="continuation-loop" style="margin-top: 80px; padding: 60px 40px; background: var(--color-secondary-bg); border-radius: 30px; border: 1px solid var(--color-border); text-align: center; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; font-size: 8rem; opacity: 0.03; font-weight: 900;">NEXT</div>
                    <h3 style="font-size: 1.8rem; margin-top: 0; color: var(--color-heading);">You've read this far ‚Äî keep going.</h3>
                    <p style="opacity: 0.7; margin-bottom: 35px; font-size: 1.1rem; max-width: 500px; margin-left: auto; margin-right: auto;">The journey to mastery is one chapter at a time. The momentum is already with you.</p>
                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        ${nextCh ? `
                            <div style="flex: 1; min-width: 280px; text-align: left; padding: 25px; background: #fff; border-radius: 20px; border: 1px solid var(--color-border); box-shadow: var(--shadow-premium);">
                                <small style="color: var(--color-accent); font-weight: 800; text-transform: uppercase; letter-spacing: 1px;">CONTINUE TO CHAPTER ${chapterIndex + 2}</small>
                                <h4 style="font-size: 1.4rem; margin: 10px 0 20px; color: var(--color-heading); line-height: 1.2;">${esc(nextCh.title)}</h4>
                                <a href="reader.html?id=${bookId}&ch=${chapterIndex + 1}" class="btn-primary" style="display: inline-block; padding: 12px 24px; border-radius: 10px;">Start Next Chapter ‚Üí</a>
                            </div>
                        ` : ''}
                        <div style="flex: 1; min-width: 280px; text-align: left; padding: 25px; background: #fff; border-radius: 20px; border: 1px solid var(--color-border); box-shadow: var(--shadow-premium);">
                            <small style="color: #64748b; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;">EXPLORE MORE</small>
                            <h4 style="font-size: 1.4rem; margin: 10px 0 20px; color: var(--color-heading); line-height: 1.2;">Popular in Library</h4>
                            <a href="books.html" class="glass" style="display: inline-block; padding: 12px 24px; border-radius: 10px; color: var(--color-text); border: 1px solid rgba(0,0,0,0.1);">Browse Library</a>
                        </div>
                    </div>
                </div>
            `;
            content += continuationHtml;

            contentDisplay.innerHTML = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(content, { ADD_ATTR: ['style'] }) : content;

            // Navigation Tabs & Sidebar
            const tabsContainer = document.getElementById('chapters-tabs-container');
            const sidebar = document.getElementById('sidebar-chapters');
            if (tabsContainer) tabsContainer.innerHTML = '';
            if (sidebar) sidebar.innerHTML = '<span class="sidebar-title">Book Category: All Book</span>';

            book.chapters.forEach((ch, idx) => {
                const isCurrent = idx === chapterIndex;
                const tab = document.createElement('a');
                tab.href = `reader.html?id=${bookId}&ch=${idx}`;
                tab.textContent = `${idx + 1}. ${ch.title}`;
                tab.style.cssText = `padding: 15px 25px; display: inline-block; white-space: nowrap; text-decoration: none; color: ${isCurrent ? 'var(--color-accent)' : 'var(--color-text)'}; opacity: ${isCurrent ? 1 : 0.6}; border-bottom: 2px solid ${isCurrent ? 'var(--color-accent)' : 'transparent'};`;
                if (tabsContainer) tabsContainer.appendChild(tab);

                const link = document.createElement('a');
                link.href = `reader.html?id=${bookId}&ch=${idx}`;
                link.className = `sidebar-link ${isCurrent ? 'active' : ''}`;
                link.textContent = `${idx + 1}. ${ch.title}`;
                if (sidebar) sidebar.appendChild(link);
            });

            // Browse All Button
            const browseBtn = document.createElement('a');
            browseBtn.href = "#";
            browseBtn.textContent = "Browse All Chapters";
            browseBtn.onclick = (e) => { e.preventDefault(); window.openChapterModal(book, chapterIndex); };
            browseBtn.style.cssText = "padding: 15px 25px; color: white; background: var(--color-accent); margin-left: auto; text-decoration: none;";
            if (tabsContainer) tabsContainer.appendChild(browseBtn);

            // Prev/Next Links
            const prevUrl = chapterIndex > 0 ? `reader.html?id=${bookId}&ch=${chapterIndex - 1}` : '#';
            const nextUrl = chapterIndex < book.chapters.length - 1 ? `reader.html?id=${bookId}&ch=${chapterIndex + 1}` : '#';

            document.getElementById('prev-chapter').href = prevUrl;
            document.getElementById('next-chapter').href = nextUrl;
            document.getElementById('prev-btn-top').href = prevUrl;
            document.getElementById('next-btn-top').href = nextUrl;

            // Update Save/Bookmark state
            const saved = JSON.parse(localStorage.getItem('saved_chapters') || '[]');
            const saveKey = `${bookId}_${chapterIndex}`;
            const isSaved = saved.some(s => s.id === saveKey);
            const btnSaveTop = document.getElementById('btn-save-top');
            const btnSaveBottom = document.getElementById('btn-save-bottom');
            if (isSaved) {
                if (btnSaveTop) btnSaveTop.classList.add('active');
                if (btnSaveBottom) btnSaveBottom.classList.add('active');
            } else {
                if (btnSaveTop) btnSaveTop.classList.remove('active');
                if (btnSaveBottom) btnSaveBottom.classList.remove('active');
            }

            if (chapterIndex === 0) {
                document.getElementById('prev-chapter').classList.add('disabled');
                document.getElementById('prev-title').textContent = "Start of Book";
            } else {
                document.getElementById('prev-chapter').classList.remove('disabled');
                document.getElementById('prev-title').textContent = book.chapters[chapterIndex - 1].title;
            }

            if (chapterIndex === book.chapters.length - 1) {
                document.getElementById('next-chapter').classList.add('disabled');
                document.getElementById('next-title').textContent = "End of Book";
            } else {
                document.getElementById('next-chapter').classList.remove('disabled');
                document.getElementById('next-title').textContent = book.chapters[chapterIndex + 1].title;
            }

            // Interactions
            if (window.checkBookInteractions) window.checkBookInteractions(bookId);
            if (window.checkChapterInteractions) window.checkChapterInteractions(bookId, chapterIndex);

            window.scrollTo(0, 0);
        };

        window.fetchFreshChapter = async function (bookId, chapterIndex, currentCachedData = null) {
            if (typeof isSupabaseConfigured !== 'function' || !isSupabaseConfigured()) return;
            try {
                const { data: bookData } = await supabaseClient.from('books').select('*').eq('id', bookId).single();
                const { data: chaptersMetadata } = await supabaseClient.from('chapters').select('id, title, chapter_number').eq('book_id', bookId).order('chapter_number', { ascending: true });
                const book = { ...bookData, chapters: chaptersMetadata || [] };
                const { data: chapter } = await supabaseClient.from('chapters').select('*').eq('book_id', bookId).eq('chapter_number', chapterIndex + 1).single();

                if (chapter) {
                    const freshResult = { book, chapter };
                    if (!currentCachedData || JSON.stringify(currentCachedData) !== JSON.stringify(freshResult)) {
                        console.log("Fresh data, updating...");
                        window.renderChapter(chapter, book, chapterIndex);
                    }
                    const cacheMap = JSON.parse(localStorage.getItem(CHAPTERS_CACHE_KEY) || '{}');
                    cacheMap[`${bookId}_${chapterIndex}`] = freshResult;
                    localStorage.setItem(CHAPTERS_CACHE_KEY, JSON.stringify(cacheMap));
                }
            } catch (e) { console.warn("Fetch failed", e); }
        };

        window.openChapterModal = function (book, currentIndex) {
            const modal = document.getElementById('chapter-browser-modal');
            const list = document.getElementById('chapter-browser-list');
            if (!modal || !list) return;
            list.innerHTML = '';
            book.chapters.forEach((ch, idx) => {
                const isActive = idx === currentIndex;
                const div = document.createElement('a');
                div.href = `reader.html?id=${book.id}&ch=${idx}`;
                div.className = 'chapter-item';
                div.style.cssText = `display: block; padding: 12px; background: ${isActive ? 'var(--color-accent)' : 'var(--color-secondary-bg)'}; color: ${isActive ? 'white' : 'var(--color-text)'}; border: 1px solid var(--color-border); text-decoration: none; border-radius: 6px;`;
                div.textContent = `${idx + 1}. ${ch.title}`;
                list.appendChild(div);
            });
            modal.style.display = 'flex';
        };

        window.closeChapterModal = function () {
            const modal = document.getElementById('chapter-browser-modal');
            if (modal) modal.style.display = 'none';
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('id');
            const chapterIndex = parseInt(urlParams.get('ch') || '0');

            if (!bookId) { window.location.href = 'books.html'; return; }

            // Cache First
            const cacheMap = JSON.parse(localStorage.getItem(CHAPTERS_CACHE_KEY) || '{}');
            const cachedData = cacheMap[`${bookId}_${chapterIndex}`];

            if (cachedData && cachedData.chapter) {
                console.log("Loaded from cache");
                window.renderChapter(cachedData.chapter, cachedData.book, chapterIndex);
                if (window.updateReaderStats) window.updateReaderStats(bookId);
            } else {
                // Fallback / Loading
                document.getElementById('reader-content-display').innerHTML = '<div style="text-align:center; padding: 50px;">Loading Chapter...</div>';
            }

            // Fetch Fresh
            await fetchFreshChapter(bookId, chapterIndex, cachedData);
            if (window.updateReaderStats) window.updateReaderStats(bookId);
        });

        // --- Interaction Helpers (Consolidated) ---
        window.updateReaderStats = async function (bookId) {
            const urlParams = new URLSearchParams(window.location.search);
            const chIndex = urlParams.get('ch') || '0';

            if (!bookId || typeof supabaseClient === 'undefined') return;

            try {
                // Get Likes
                const { count: likes } = await supabaseClient.from('user_activity')
                    .select('*', { count: 'exact', head: true })
                    .eq('activity_type', 'like_chapter')
                    .eq('metadata->>book_id', bookId)
                    .eq('metadata->>chapter_index', chIndex);

                // Get Dislikes
                const { count: dislikes } = await supabaseClient.from('user_activity')
                    .select('*', { count: 'exact', head: true })
                    .eq('activity_type', 'dislike_chapter')
                    .eq('metadata->>book_id', bookId)
                    .eq('metadata->>chapter_index', chIndex);

                document.querySelectorAll('#count-like-top, #count-like-bottom').forEach(el => el.textContent = likes || 0);
                document.querySelectorAll('#count-dislike-top, #count-dislike-bottom').forEach(el => el.textContent = dislikes || 0);
            } catch (e) { console.error("Stats error", e); }
        };

        async function getIpAddress() {
            try {
                let ip = sessionStorage.getItem('user_ip');
                if (ip) return ip;
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                sessionStorage.setItem('user_ip', data.ip);
                return data.ip;
            } catch { return '0.0.0.0'; }
        }

        window.checkChapterInteractions = async function (bookId, chIndex) {
            const interactions = JSON.parse(localStorage.getItem('userInteractions') || '{}');
            const chInter = (interactions[bookId] && interactions[bookId].chapters && interactions[bookId].chapters[chIndex]) || {};

            if (chInter.liked) document.querySelectorAll('#btn-like-top, #btn-like-bottom').forEach(e => e.classList.add('active'));
            if (chInter.disliked) document.querySelectorAll('#btn-dislike-top, #btn-dislike-bottom').forEach(e => e.classList.add('active'));

            // Sync counts code omitted for brevity but should be here ideally, relying on updateReaderStats mainly
        };

        // Basic toggles with simplified logic
        // Helper to update interaction UI locally
        function updateInteractionUI(type, isActive) {
            const topBtn = document.getElementById(`btn-${type}-top`);
            const bottomBtn = document.getElementById(`btn-${type}-bottom`);
            if (isActive) {
                if (topBtn) topBtn.classList.add('active');
                if (bottomBtn) bottomBtn.classList.add('active');
            } else {
                if (topBtn) topBtn.classList.remove('active');
                if (bottomBtn) bottomBtn.classList.remove('active');
            }
        }

        window.toggleChapterLike = async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('id');
            const chIndex = urlParams.get('ch') || '0';
            const ip = await getIpAddress();

            if (!ip || !bookId) return;

            const interactions = JSON.parse(localStorage.getItem('userInteractions') || '{}');
            if (!interactions[bookId]) interactions[bookId] = {};
            if (!interactions[bookId].chapters) interactions[bookId].chapters = {};
            if (!interactions[bookId].chapters[chIndex]) interactions[bookId].chapters[chIndex] = {};

            const chInter = interactions[bookId].chapters[chIndex];
            const wasLiked = chInter.liked;
            const likeEls = document.querySelectorAll('#count-like-top, #count-like-bottom');
            const dislikeEls = document.querySelectorAll('#count-dislike-top, #count-dislike-bottom');

            try {
                if (wasLiked) {
                    // Remove like
                    await supabaseClient.from('user_activity').delete()
                        .eq('ip_address', ip).eq('metadata->>book_id', bookId)
                        .eq('metadata->>chapter_index', chIndex).eq('activity_type', 'like_chapter');

                    chInter.liked = false;
                    updateInteractionUI('like', false);
                    likeEls.forEach(el => el.textContent = Math.max(0, parseInt(el.textContent || '0') - 1));
                } else {
                    // Remove dislike if present (without calling toggleChapterDislike)
                    if (chInter.disliked) {
                        await supabaseClient.from('user_activity').delete()
                            .eq('ip_address', ip).eq('metadata->>book_id', bookId)
                            .eq('metadata->>chapter_index', chIndex).eq('activity_type', 'dislike_chapter');

                        chInter.disliked = false;
                        updateInteractionUI('dislike', false);
                        dislikeEls.forEach(el => el.textContent = Math.max(0, parseInt(el.textContent || '0') - 1));
                    }

                    // Add like
                    await supabaseClient.from('user_activity').insert([{
                        ip_address: ip, activity_type: 'like_chapter',
                        metadata: { book_id: bookId, chapter_index: chIndex },
                        page_url: window.location.href
                    }]);

                    chInter.liked = true;
                    updateInteractionUI('like', true);
                    likeEls.forEach(el => el.textContent = parseInt(el.textContent || '0') + 1);
                }
                localStorage.setItem('userInteractions', JSON.stringify(interactions));
            } catch (e) { console.error("Like error", e); }
        };

        window.toggleChapterDislike = async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('id');
            const chIndex = urlParams.get('ch') || '0';
            const ip = await getIpAddress();

            if (!ip || !bookId) return;

            const interactions = JSON.parse(localStorage.getItem('userInteractions') || '{}');
            if (!interactions[bookId]) interactions[bookId] = {};
            if (!interactions[bookId].chapters) interactions[bookId].chapters = {};
            if (!interactions[bookId].chapters[chIndex]) interactions[bookId].chapters[chIndex] = {};

            const chInter = interactions[bookId].chapters[chIndex];
            const wasDisliked = chInter.disliked;
            const dislikeEls = document.querySelectorAll('#count-dislike-top, #count-dislike-bottom');
            const likeEls = document.querySelectorAll('#count-like-top, #count-like-bottom');

            try {
                if (wasDisliked) {
                    // Remove dislike
                    await supabaseClient.from('user_activity').delete()
                        .eq('ip_address', ip).eq('metadata->>book_id', bookId)
                        .eq('metadata->>chapter_index', chIndex).eq('activity_type', 'dislike_chapter');

                    chInter.disliked = false;
                    updateInteractionUI('dislike', false);
                    dislikeEls.forEach(el => el.textContent = Math.max(0, parseInt(el.textContent || '0') - 1));
                } else {
                    // Remove like if present (without calling toggleChapterLike)
                    if (chInter.liked) {
                        await supabaseClient.from('user_activity').delete()
                            .eq('ip_address', ip).eq('metadata->>book_id', bookId)
                            .eq('metadata->>chapter_index', chIndex).eq('activity_type', 'like_chapter');

                        chInter.liked = false;
                        updateInteractionUI('like', false);
                        likeEls.forEach(el => el.textContent = Math.max(0, parseInt(el.textContent || '0') - 1));
                    }

                    // Add dislike
                    await supabaseClient.from('user_activity').insert([{
                        ip_address: ip, activity_type: 'dislike_chapter',
                        metadata: { book_id: bookId, chapter_index: chIndex },
                        page_url: window.location.href
                    }]);

                    chInter.disliked = true;
                    updateInteractionUI('dislike', true);
                    dislikeEls.forEach(el => el.textContent = parseInt(el.textContent || '0') + 1);
                }
                localStorage.setItem('userInteractions', JSON.stringify(interactions));
            } catch (e) { console.error("Dislike error", e); }
        };

        window.toggleSaveReader = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (!id) return;

            let favs = JSON.parse(localStorage.getItem('userFavorites') || '[]');
            if (favs.includes(id)) {
                favs = favs.filter(fid => fid !== id);
                updateInteractionUI('save', false);
                if (window.showToast) showToast("Removed from favorites", "info");
            } else {
                favs.push(id);
                updateInteractionUI('save', true);
                if (window.showToast) showToast("Added to favorites", "success");
            }
            localStorage.setItem('userFavorites', JSON.stringify(favs));
        };

        // Music
        function toggleMusic() {
            const audio = document.getElementById('bg-music');
            const btn = document.getElementById('music-toggle');
            if (audio.paused) { audio.play(); btn.classList.add('playing'); }
            else { audio.pause(); btn.classList.remove('playing'); }
        }

        // Review Modal
        window.jumpToCommentsReader = function () { document.getElementById('chapter-review-modal').style.display = 'flex'; };
        window.closeChapterReviewModal = function () { document.getElementById('chapter-review-modal').style.display = 'none'; };
        window.setChapterRating = function (r) {
            window.currentChapterRating = r;
            document.querySelectorAll('.star-box').forEach((s, i) => s.style.color = (i < r) ? 'gold' : '#ccc');
        };
        window.submitChapterReview = async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('id');
            const chIndex = urlParams.get('ch') || '0';
            const name = document.getElementById('chapter-review-name').value.trim();
            const comment = document.getElementById('chapter-review-comment').value.trim();
            const rating = window.currentChapterRating || 0;
            const chTitle = document.getElementById('chapter-title-display').textContent;

            if (!name || !comment || rating === 0) {
                if (window.customAlert) customAlert("Please fill all fields and select a rating.", "warning");
                else alert("Please fill all fields.");
                return;
            }

            if (typeof isSupabaseConfigured !== 'function' || !isSupabaseConfigured()) {
                alert("Cloud sync required for reviews."); return;
            }

            try {
                // Resolve UUID for legacy IDs
                let targetUuid = bookId;
                const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(bookId);

                if (!isUuid) {
                    const { data: bookRef } = await supabaseClient.from('books').select('id').eq('title', document.getElementById('book-title-main').textContent).single();
                    if (bookRef) targetUuid = bookRef.id;
                    else throw new Error("Book sync required");
                }

                const ip = await getIpAddress();
                // Note: Removed chapter_number, chapter_title, and ip_address due to Supabase schema cache issues.
                // These fields exist in SQL but PostgREST cache seems out of sync or they were never applied.
                const { error } = await supabaseClient.from('book_reviews').insert({
                    book_id: targetUuid,
                    username: name,
                    rating: rating,
                    comment: comment
                });

                if (error) throw error;

                if (window.customAlert) customAlert("Review submitted!", "success");
                else alert("Review submitted!");
                closeChapterReviewModal();
            } catch (e) {
                console.error(e);
                if (window.customAlert) customAlert("Failed to submit review.", "error");
            }
        };

        window.toggleReportReader = function () {
            if (window.customReport) {
                window.customReport().then(async (data) => {
                    if (data) {
                        const urlParams = new URLSearchParams(window.location.search);
                        const id = urlParams.get('id');
                        const interactions = JSON.parse(localStorage.getItem('userInteractions') || '{}');
                        if (!interactions[id]) interactions[id] = {};

                        interactions[id].reported = true;
                        interactions[id].reportInfo = { reporter: data.name, reason: data.reason, date: new Date().toISOString() };
                        localStorage.setItem('userInteractions', JSON.stringify(interactions));

                        document.getElementById('btn-report-top').style.color = '#ef4444';
                        document.querySelector('#btn-report-top span').textContent = 'Reported';

                        if (window.supabaseClient) {
                            const payload = { type: 'content_report', reason: data.reason, metadata: { book_id: id, url: window.location.href, source: 'reader' } };
                            await supabaseClient.from('site_feedback').insert([{
                                name: data.name || 'Anonymous', email: 'report@system', message: JSON.stringify(payload)
                            }]);
                        }
                        if (window.customAlert) customAlert("Report submitted.", "success");
                    }
                });
            } else { alert("Report feature not loaded."); }
        };

        window.openOriginalContent = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const ch = urlParams.get('ch') || '0';
            if (id) window.location.href = `reader.html?id=${id}&ch=${ch}&mode=original`; // Placeholder redirection
        };
        window.shareBookReader = function () {
            navigator.clipboard.writeText(window.location.href);
            alert("Link copied!");
        };

    </script>
</body>

</html>