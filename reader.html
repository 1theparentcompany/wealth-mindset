<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reader - Wealth & Mindset</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Playfair+Display:ital,wght@0,700;0,800;1,700&family=Outfit:wght@600;700;800&family=Lora:ital,wght@0,400;0,700;1,400;1,700&family=Georgia&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <!-- Security: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://nlgdthlwmagvjvzrubif.supabase.co; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://nlgdthlwmagvjvzrubif.supabase.co wss://nlgdthlwmagvjvzrubif.supabase.co; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; media-src 'self' https://www.soundjay.com; frame-src 'self'; object-src 'none';">
    <!-- Supabase SDK -->
    <script src="js/lib/supabase-js.js" defer></script>
    <script src="js/supabase-config.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="js/image-utils.js" defer></script>
    <script src="js/modal-utils.js" defer></script>
    <style>
        .reader-container {
            max-width: var(--content-max-width);
            margin: clamp(20px, 5vw, 60px) auto;
            padding: 0 var(--spacing-unit);
            transition: var(--transition-smooth);
        }

        .reader-header {
            margin-bottom: 80px;
            text-align: center;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 60px;
            position: relative;
        }

        .reader-book-title {
            font-family: var(--font-heading);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--color-accent);
            font-weight: 700;
            margin-bottom: 16px;
            display: block;
        }

        .reader-chapter-title {
            font-size: var(--font-size-h2);
            font-weight: 800;
            color: var(--color-heading);
            margin: 0;
            line-height: 1.1;
            font-family: var(--font-heading);
            letter-spacing: -1.5px;
        }

        .reader-content {
            font-family: var(--font-reading);
            font-size: clamp(18px, 1.2vw, 21px);
            line-height: 1.85;
            color: var(--color-text);
            white-space: pre-wrap;
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        .reader-content p {
            margin-bottom: 2.2em;
        }

        .reader-content h2 {
            font-family: var(--font-heading);
            font-size: 2.25rem;
            color: var(--color-heading);
            margin: 2em 0 1em;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .reader-content h3 {
            font-family: var(--font-heading);
            font-size: 1.75rem;
            color: var(--color-heading);
            margin: 1.5em 0 0.8em;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .reader-content b,
        .reader-content strong {
            color: var(--color-heading);
            font-weight: 700;
        }

        .reader-content i,
        .reader-content em {
            color: var(--color-accent);
            font-style: italic;
        }

        .reader-content mark {
            background: var(--color-accent-glow);
            color: var(--color-accent);
            padding: 0 6px;
            border-radius: 4px;
        }

        .chapter-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 100px;
            padding: 60px 0;
            border-top: 1px solid var(--color-border);
        }

        .nav-link {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-decoration: none !important;
            transition: transform 0.3s ease;
        }

        .nav-link:hover {
            transform: translateY(-5px);
        }

        .nav-link .nav-label {
            font-family: var(--font-heading);
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 2px;
            font-weight: 700;
        }

        .nav-link .nav-title {
            font-weight: 800;
            font-size: 1.25rem;
            color: var(--color-heading);
            font-family: var(--font-heading);
            letter-spacing: -0.5px;
        }

        .nav-link.disabled {
            opacity: 0.2;
            pointer-events: none;
        }

        .chapter-list-sidebar {
            position: fixed;
            left: 30px;
            top: 120px;
            width: 280px;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: var(--shadow-premium);
            transition: all 0.3s ease;
        }

        .sidebar-title {
            font-family: var(--font-heading);
            font-weight: 800;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 24px;
            display: block;
            color: var(--color-accent);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 12px;
        }

        .sidebar-link {
            display: block;
            padding: 12px 16px;
            font-size: 0.95rem;
            color: var(--color-text);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .sidebar-link:hover {
            background: rgba(37, 99, 235, 0.1);
            color: var(--color-accent);
            transform: translateX(5px);
        }

        .sidebar-link.active {
            background: var(--color-accent);
            color: white !important;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
        }

        @media (max-width: 1500px) {
            .chapter-list-sidebar {
                display: none;
            }
        }

        /* Reader Social Interactions */
        .reader-nav-interactions {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(var(--glass-blur));
            border-radius: 100px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .interaction-btn {
            background: transparent;
            border: none;
            color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 42px;
            height: 42px;
            padding: 0 12px;
            border-radius: 21px;
        }

        .interaction-btn:hover {
            color: var(--color-accent);
            background: var(--color-accent-glow);
            transform: translateY(-2px);
        }

        .interaction-btn svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            flex-shrink: 0;
        }

        .interaction-btn .count {
            font-size: 0.85rem;
            font-weight: 700;
            font-family: var(--font-heading);
        }

        .interaction-btn.active {
            color: var(--color-accent);
            background: var(--color-accent-glow);
        }

        .interaction-btn.active svg {
            fill: currentColor;
        }

        /* Music Toggle Button */
        .music-control {
            position: fixed;
            bottom: 40px;
            right: 40px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            padding: 12px 24px;
            border-radius: 100px;
            border: 1px solid var(--glass-border);
            color: var(--color-text);
            font-family: var(--font-heading);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-premium);
        }

        .music-control:hover {
            transform: translateY(-5px);
            border-color: var(--color-accent);
        }

        .music-control.playing {
            color: var(--color-accent);
            border-color: var(--color-accent);
        }

        .music-control .icon {
            font-size: 1.25rem;
            width: 36px;
            height: 36px;
            background: var(--color-secondary-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .music-control.playing .icon {
            background: var(--color-accent);
            color: white;
            animation: pulse-music 2s infinite;
        }

        @keyframes pulse-music {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(37, 99, 235, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
            }
        }

        /* Custom Background Support with Vibrancy Boost */
        body.has-custom-bg {
            background-color: #020617;
            position: relative;
            min-height: 100vh;
        }

        body.has-custom-bg::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--custom-bg-url);
            background-size: var(--custom-bg-size, cover);
            background-position: center;
            background-attachment: fixed;
            z-index: -2;
            filter: brightness(1.2) saturate(1.2);
            /* Boost vibrancy significantly */
            pointer-events: none;
        }

        body.has-custom-bg::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--custom-bg-overlay);
            z-index: -1;
            pointer-events: none;
        }

        body.has-custom-bg {
            --custom-bg-overlay: linear-gradient(to bottom, rgba(6, 11, 25, 0.4), rgba(6, 11, 25, 0.7));
        }

        .reader-container.has-custom-bg {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border-radius: 32px;
            padding: 80px 60px;
            box-shadow: var(--shadow-premium);
            border: 1px solid var(--glass-border);
        }

        body.home-theme.has-custom-bg .nav-title,
        body.home-theme.has-custom-bg .reader-chapter-title,
        body.home-theme.has-custom-bg .reader-content h2,
        body.home-theme.has-custom-bg .reader-content h3,
        body.dark-mode.has-custom-bg .nav-title,
        body.dark-mode.has-custom-bg .reader-chapter-title,
        body.dark-mode.has-custom-bg .reader-content h2,
        body.dark-mode.has-custom-bg .reader-content h3 {
            color: #fff !important;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        body.home-theme.has-custom-bg .reader-content,
        body.dark-mode.has-custom-bg .reader-content {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* Modal & Toast Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: modalFadeUp 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        @keyframes modalFadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toast-container {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 11000;
        }

        .toast {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            color: white;
            padding: 16px 32px;
            border-radius: 100px;
            font-weight: 700;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: toastSlideIn 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .toast.hide {
            animation: toastSlideOut 0.3s ease-in forwards;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        /* Multi-Language Expander UI */
        .lang-expand-container {
            user-select: none;
        }

        .lang-expand-trigger:hover {
            background: rgba(37, 99, 235, 0.2) !important;
            border-color: rgba(37, 99, 235, 0.4) !important;
            transform: translateY(-2px);
        }

        .lang-expand-trigger:active {
            transform: translateY(0);
        }

        .lang-opt:hover {
            background: rgba(255, 255, 255, 0.05) !important;
            transform: translateX(5px);
        }

        .lang-opt.active:hover {
            background: rgba(37, 99, 235, 0.2) !important;
        }

        #lang-expand-options {
            animation: dropdownFade 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
            transform-origin: top right;
        }

        @keyframes dropdownFade {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>

<body class="home-theme">

    <header class="site-header">
        <div
            style="max-width: var(--max-width); width: 100%; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 var(--spacing-unit); box-sizing: border-box;">
            <div class="logo">
                <a href="index.html">
                    <img src="assets/logo-new.png" alt="Wealth & Mindset" class="logo-img" loading="eager"
                        fetchpriority="high">
                    <span>Wealth & Mindset</span>
                </a>
            </div>
            <nav>
                <a href="index.html">Home</a>
                <a href="books.html">Library</a>
                <a href="about.html" class="nav-about">About</a>
                <a href="contact.html" class="nav-contact">Contact</a>
                <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">üåô</button>
            </nav>
        </div>
    </header>

    <!-- Background Music Element -->
    <audio id="bg-music" loop preload="auto">
        <source src="https://www.soundjay.com/nature/rain-07.mp3" type="audio/mpeg">
    </audio>

    <!-- Music Control Toggle -->
    <button class="music-control" id="music-toggle" onclick="toggleMusic()">
        <span class="music-status-text">Rain Ambient</span>
        <div class="icon">üåßÔ∏è</div>
    </button>

    <main style="max-width: 100%; margin: 0 auto; padding: 0;">
        <!-- Header Section -->
        <section class="book-banner-top"
            style="max-width: 1400px; margin: 0 auto; padding: 40px var(--spacing-unit) 0;">
            <div
                style="display: flex; justify-content: space-between; align-items: flex-end; gap: 40px; margin-bottom: 30px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; opacity: 0.7;">
                        <img src="assets/logo-new.png" alt="" style="height: 20px; border-radius: 4px;" loading="lazy">
                        <span
                            style="font-weight: 700; text-transform: uppercase; letter-spacing: 2px; font-size: 0.75rem; color: var(--color-accent);">Premium
                            Reading</span>
                    </div>
                    <h1 id="book-title-main"
                        style="font-size: var(--font-size-h2); font-weight: 800; color: var(--color-heading); margin: 0; letter-spacing: -1.5px; line-height: 1.1; font-family: var(--font-heading);">
                        Book Title
                    </h1>
                </div>

                <div class="ad-container" style="margin: 0; flex-shrink: 0;">
                    <span class="ad-label">Support Our Platform</span>
                    <div class="glass"
                        style="padding: 20px 40px; text-align: center; border-radius: 16px; border: 1px dashed var(--color-border);">
                        <div style="font-weight: 700; font-size: 1rem; color: var(--color-text); opacity: 0.5;">[
                            Premium Banner Slot ]</div>
                    </div>
                </div>
            </div>

            <div class="top-interactions"
                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 40px; padding: 16px; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 30px 60px rgba(0,0,0,0.3); flex-wrap: wrap; gap: 20px;">
                <div class="reader-nav-interactions" style="flex-wrap: wrap;">
                    <button class="interaction-btn" id="btn-like-top" onclick="toggleChapterLike()" title="Like">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" />
                        </svg>
                        <span class="count" id="count-like-top">0</span>
                    </button>
                    <button class="interaction-btn" id="btn-dislike-top" onclick="toggleChapterDislike()"
                        title="Dislike">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.37-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z" />
                        </svg>
                        <span class="count" id="count-dislike-top">0</span>
                    </button>
                    <button class="interaction-btn" id="btn-comment-top" onclick="jumpToCommentsReader()"
                        title="Comment">
                        <svg viewBox="0 0 24 24">
                            <path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z" />
                        </svg>
                    </button>
                    <button class="interaction-btn" id="btn-save-top" onclick="toggleSaveReader()" title="Save">
                        <svg viewBox="0 0 24 24">
                            <path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z" />
                        </svg>
                    </button>
                    <button class="interaction-btn" id="btn-share-top" onclick="shareBookReader()" title="Share">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z" />
                        </svg>
                    </button>
                </div>

                <div style="display: flex; align-items: center; gap: clamp(20px, 5vw, 40px); flex-wrap: wrap;">
                    <div id="top-lang-selector-container"></div>
                    <div
                        style="font-size: 0.95rem; color: #f8fafc; font-weight: 700; display: flex; gap: clamp(15px, 3vw, 24px); font-family: var(--font-heading); align-items: center;">
                        <span style="display: flex; align-items: center; gap: 8px; opacity: 0.8;"
                            id="reader-reads-count">üëÅÔ∏è -- Reads</span>
                        <span style="display: flex; align-items: center; gap: 8px; color: #fbbf24;"
                            id="reader-rating-display">‚≠ê -- Rating</span>
                    </div>
                </div>
            </div>


            <!-- Chapter Tabs with Flat Style -->
            <div class="chapters-tabs-outer"
                style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 40px; border-bottom: 1px solid rgba(255,255,255,0.1); scrollbar-width: none;">
                <div class="chapters-tabs-container" id="chapters-tabs-container"
                    style="display: flex; justify-content: flex-start; min-width: max-content;">
                    <!-- Tabs with names injected here -->
                </div>
            </div>
        </section>

        <div class="page-container" style="margin-top: 0;">
            <!-- Left Sidebar Ads & TOC -->
            <aside class="side-sidebar left">
                <div class="sticky-ads">
                    <!-- Chapter List (TOC) -->
                    <div class="chapter-list-sidebar" id="sidebar-chapters"
                        style="position: static; width: 100%; margin-bottom: 20px; box-sizing: border-box;">
                        <span class="sidebar-title">Book Category: All Book</span>
                    </div>

                    <!-- Left Sidebar Ad 1 -->
                    <div class="vertical-ad-banner">
                        <span class="ad-label">Advertisement</span>
                        <div style="font-weight: bold; margin-bottom: 10px;">[Sidebar Banner 1]</div>
                        <div style="font-size: 0.7rem; opacity: 0.6;">300 x 600</div>
                    </div>
                    <!-- Left Sidebar Ad 2 -->
                    <div class="vertical-ad-banner">
                        <span class="ad-label">Advertisement</span>
                        <div style="font-weight: bold; margin-bottom: 10px;">[Sidebar Banner 2]</div>
                        <div style="font-size: 0.7rem; opacity: 0.6;">300 x 600</div>
                    </div>
                </div>
            </aside>

            <!-- Main Reading Area -->
            <div class="main-layout-content">

                <div class="reader-container" style="margin-top: 40px;">
                    <!-- Simple Header for Reading Context -->
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 2px solid var(--color-border); margin-bottom: 50px;">
                        <div>
                            <a href="javascript:history.back()"
                                style="text-decoration: none; font-size: 0.95rem; color: var(--color-text); display: flex; align-items: center; gap: 8px; font-weight: 700; opacity: 0.7; transition: 0.2s;"
                                onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                                <span>‚ùÆ</span> BACK
                            </a>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <a href="#" id="prev-btn-top" class="glass"
                                style="padding: 10px 24px; border-radius: 100px; font-size: 0.85rem; font-weight: 700; color: var(--color-text); text-decoration: none; transition: 0.3s;">‚ùÆ
                                PREV</a>
                            <a href="#" id="next-btn-top" class="glass"
                                style="padding: 10px 24px; border-radius: 100px; font-size: 0.85rem; font-weight: 700; color: #fff; background: var(--color-accent); text-decoration: none; transition: 0.3s;">NEXT
                                ‚ùØ</a>
                        </div>
                    </div>

                    <header class="reader-header"
                        style="border: none; text-align: left; padding-bottom: 0; margin-bottom: 40px; display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span id="reading-ch-label" class="reader-book-title" style="margin: 0;">Chapter --</span>
                            <div id="lang-selector-container"></div>
                        </div>
                        <h1 class="reader-chapter-title" id="chapter-title-display">Chapter Title</h1>
                    </header>


                    <article class="reader-content" id="reader-content-display">
                        <!-- Content goes here -->
                    </article>

                    <!-- Ad Space: Middle -->
                    <div class="ad-container ad-middle">
                        <span class="ad-label">Advertisement</span>
                        <div>[In-Text Ad - 300x250]</div>
                    </div>

                    <nav class="chapter-navigation">
                        <a href="#" class="nav-link" id="prev-chapter">
                            <span class="nav-label">Previous Chapter</span>
                            <span class="nav-title" id="prev-title">---</span>
                        </a>

                        <!-- Interaction Group Centered -->
                        <div class="reader-nav-interactions">
                            <button class="interaction-btn" id="btn-like-bottom" onclick="toggleChapterLike()"
                                title="Like">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" />
                                </svg>
                                <span class="count" id="count-like-bottom">0</span>
                            </button>
                            <button class="interaction-btn" id="btn-dislike-bottom" onclick="toggleChapterDislike()"
                                title="Dislike">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.37-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z" />
                                </svg>
                                <span class="count" id="count-dislike-bottom">0</span>
                            </button>
                            <button class="interaction-btn" id="btn-save-bottom" onclick="toggleSaveReader()"
                                title="Save">
                                <svg viewBox="0 0 24 24">
                                    <path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z" />
                                </svg>
                            </button>
                            <button class="interaction-btn" id="btn-comment-bottom" onclick="jumpToCommentsReader()"
                                title="Comment">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z" />
                                </svg>
                            </button>
                        </div>

                        <a href="#" class="nav-link" id="next-chapter" style="text-align: right;">
                            <span class="nav-label">Up Next</span>
                            <span class="nav-title" id="next-title">---</span>
                        </a>
                    </nav>
                </div>

                <!-- Ad Space: Bottom -->
                <div class="ad-container ad-bottom">
                    <span class="ad-label">Advertisement</span>
                    <div>[Footer Banner - 728x90]</div>
                </div>
            </div>

            <!-- Right Sidebar Ads -->
            <aside class="side-sidebar right">
                <div class="sticky-ads">
                    <div class="vertical-ad-banner glass">
                        <span class="ad-label">Support Our Platform</span>
                        <div style="font-weight: 800; margin-bottom: 12px; color: var(--color-heading);">[ Premium Slot
                            1 ]</div>
                        <div style="font-size: 0.75rem; opacity: 0.5; font-weight: 600;">300 x 600 - Vertical</div>
                    </div>
                    <div class="vertical-ad-banner glass">
                        <span class="ad-label">Support Our Platform</span>
                        <div style="font-weight: 800; margin-bottom: 12px; color: var(--color-heading);">[ Premium Slot
                            2 ]</div>
                        <div style="font-size: 0.75rem; opacity: 0.5; font-weight: 600;">300 x 600 - Vertical</div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Chapter Review Modal -->
        <div id="chapter-review-modal" class="modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center;">
            <div class="modal-content glass"
                style="padding: 40px; border-radius: 24px; max-width: 550px; width: 90%; border: 1px solid var(--glass-border); box-shadow: var(--shadow-premium);">
                <h3
                    style="margin: 0 0 12px 0; color: var(--color-heading); font-size: 1.85rem; font-family: var(--font-heading); font-weight: 800; letter-spacing: -1px;">
                    üìù Review Chapter</h3>
                <p style="color: var(--color-text); font-size: 1rem; margin-bottom: 30px; opacity: 0.7;">Share your
                    thoughts about <span id="chapter-review-title"
                        style="color: var(--color-accent); font-weight: 800;"></span></p>

                <div style="margin-bottom: 24px;">
                    <label
                        style="display: block; color: var(--color-heading); font-size: 0.85rem; margin-bottom: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;">Your
                        Name</label>
                    <input type="text" id="chapter-review-name" placeholder="How should we call you?"
                        style="width: 100%; padding: 14px; background: var(--color-secondary-bg); border: 1px solid var(--color-border); border-radius: 12px; color: var(--color-text); font-size: 1rem; outline: none; transition: 0.3s;"
                        onfocus="this.style.borderColor='var(--color-accent)'">
                </div>

                <div style="margin-bottom: 24px;">
                    <label
                        style="display: block; color: var(--color-heading); font-size: 0.85rem; margin-bottom: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;">Rating</label>
                    <div id="chapter-rating-stars" style="display: flex; gap: 12px; font-size: 2.25rem;">
                        <span class="star-box" data-value="1" onclick="setChapterRating(1)"
                            style="cursor: pointer; color: var(--color-border); transition: 0.2s;">‚òÖ</span>
                        <span class="star-box" data-value="2" onclick="setChapterRating(2)"
                            style="cursor: pointer; color: var(--color-border); transition: 0.2s;">‚òÖ</span>
                        <span class="star-box" data-value="3" onclick="setChapterRating(3)"
                            style="cursor: pointer; color: var(--color-border); transition: 0.2s;">‚òÖ</span>
                        <span class="star-box" data-value="4" onclick="setChapterRating(4)"
                            style="cursor: pointer; color: var(--color-border); transition: 0.2s;">‚òÖ</span>
                        <span class="star-box" data-value="5" onclick="setChapterRating(5)"
                            style="cursor: pointer; color: var(--color-border); transition: 0.2s;">‚òÖ</span>
                    </div>
                </div>

                <div style="margin-bottom: 32px;">
                    <label
                        style="display: block; color: var(--color-heading); font-size: 0.85rem; margin-bottom: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;">Your
                        Insight</label>
                    <textarea id="chapter-review-comment" placeholder="What resonated with you in this chapter?"
                        style="width: 100%; min-height: 140px; padding: 14px; background: var(--color-secondary-bg); border: 1px solid var(--color-border); border-radius: 12px; color: var(--color-text); font-size: 1rem; resize: vertical; outline: none; transition: 0.3s;"
                        onfocus="this.style.borderColor='var(--color-accent)'"></textarea>
                </div>

                <div style="display: flex; gap: 16px;">
                    <button onclick="submitChapterReview()"
                        style="flex: 1.5; background: var(--color-accent); color: white; padding: 16px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 1rem; transition: 0.3s; box-shadow: 0 10px 20px var(--color-accent-glow);"
                        onmouseover="this.style.transform='translateY(-3px)'"
                        onmouseout="this.style.transform='translateY(0)'">SUBMIT REVIEW</button>
                    <button onclick="closeChapterReviewModal()"
                        style="flex: 1; background: var(--color-secondary-bg); color: var(--color-text); padding: 16px; border: 1px solid var(--color-border); border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: 0.3s;"
                        onmouseover="this.style.background='var(--color-border)'"
                        onmouseout="this.style.background='var(--color-secondary-bg)'">CANCEL</button>
                </div>
            </div>
        </div>
    </main>

    <script src="js/modal-utils.js"></script>
    <script src="js/script.js"></script>
    <script src="js/cache-utils.js"></script>
    <script>
        // Language Selector Utils (Defined early)
        window.renderLanguageSelector = async function (book) {
            const containers = [
                document.getElementById('lang-selector-container'),
                document.getElementById('top-lang-selector-container')
            ].filter(el => el !== null);

            if (!book || containers.length === 0) return;

            console.log("Initializing Language Selector for:", book.title, "ID:", book.id, "Original ID:", book.original_book_id);

            let currentBook = book;
            let familyId = currentBook.original_book_id || currentBook.id;
            let variants = [currentBook];

            // 1. Try Supabase fetch if configured
            const hasSupabase = typeof isSupabaseConfigured === 'function' && isSupabaseConfigured();

            if (hasSupabase) {
                try {
                    // Upgrade numeric ID to UUID by title if possible
                    if (typeof isValidUUID === 'function' && !isValidUUID(familyId)) {
                        console.log("Legacy ID detected, attempting Supabase title match for:", currentBook.title);
                        const { data: cloudRef, error: refError } = await supabaseClient
                            .from('books')
                            .select('id')
                            .eq('title', currentBook.title)
                            .is('original_book_id', null)
                            .maybeSingle();

                        if (refError) console.warn("Supabase ref fetch error:", refError);

                        if (cloudRef && cloudRef.id) {
                            console.log("Found Supabase UUID for title:", cloudRef.id);
                            familyId = cloudRef.id;
                        } else {
                            console.log("No Supabase entry found for title:", currentBook.title);
                        }
                    }

                    // Only proceed with Supabase fetch if we now have a valid UUID
                    if (typeof isValidUUID === 'function' && isValidUUID(familyId)) {
                        console.log("Fetching variants for familyId:", familyId);
                        const { data, error } = await supabaseClient
                            .from('books')
                            .select('id, language, title, original_book_id, status')
                            .or(`id.eq.${familyId},original_book_id.eq.${familyId}`);

                        if (error) throw error;

                        if (data && data.length > 0) {
                            variants = data;
                            console.log("Found variants in Supabase:", variants.length);
                        }
                    }
                } catch (e) {
                    console.warn("Failed to fetch lang variants from Supabase", e);
                }
            }

            // 2. Local Fallback / Enhancement
            // Even if Supabase worked, we check local storage for any extra cached items 
            // OR if Supabase failed, this is our primary source.
            try {
                const library = JSON.parse(localStorage.getItem('siteLibrary') || '[]');
                // Note: siteLibrary might only have originals, but we check anyway
                const localVariants = library.filter(b =>
                    b.id === familyId ||
                    b.original_book_id === familyId ||
                    (b.id === currentBook.id)
                );

                // Merge unique by ID
                const seenIds = new Set(variants.map(v => v.id));
                localVariants.forEach(lv => {
                    if (!seenIds.has(lv.id)) {
                        variants.push({
                            id: lv.id,
                            language: lv.language || lv.lang || 'en',
                            title: lv.title,
                            original_book_id: lv.original_book_id
                        });
                        seenIds.add(lv.id);
                    }
                });
            } catch (e) {
                console.warn("Local storage fallback failed", e);
            }

            const uniqueVariants = Array.from(new Map(variants.map(v => [v.id, v])).values());

            function getLangName(code) {
                const map = {
                    'en': 'English', 'es': 'Spanish', 'fr': 'French', 'hi': 'Hindi',
                    'de': 'German', 'zh': 'Chinese', 'jp': 'Japanese', 'ru': 'Russian',
                    'pt': 'Portuguese', 'ar': 'Arabic', 'bn': 'Bengali', 'ur': 'Urdu'
                };
                const cleanCode = (code || 'en').toLowerCase().trim();
                return map[cleanCode] || cleanCode.toUpperCase();
            }

            const currentLangName = getLangName(currentBook.language);

            // Hide selector if only one language available
            if (uniqueVariants.length <= 1) {
                console.log("Only one language variant found. Selector remains minimized/simple.");
                // We still render it but it won't have other options to click
            }

            // Inject into each container with unique IDs
            containers.forEach((container, idx) => {
                const instanceId = `lang-inst-${idx}`;
                container.innerHTML = `
                    <div class="lang-expand-container" id="${instanceId}-container" style="display: flex; align-items: center; gap: 12px; font-family: var(--font-heading); position: relative;">
                        <span style="font-size: 0.7rem; color: rgba(255,255,255,0.4); font-weight: 800; text-transform: uppercase; letter-spacing: 2px;">LANGUAGE:</span>
                        <div class="lang-expand-trigger" onclick="toggleLangOptions(event, '${instanceId}')" 
                            style="display: flex; align-items: center; gap: 14px; padding: 8px 20px; background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(255,255,255,0.1); color: #fff; border-radius: 12px; font-size: 0.85rem; cursor: pointer; font-weight: 700; transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.3); min-width: 150px; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: var(--color-accent); font-size: 1rem; font-weight: 400;">Êñá</span>
                                <span>${currentLangName}</span>
                            </div>
                            ${uniqueVariants.length > 1 ? `
                            <svg class="arrow-icon" viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor; opacity: 0.5; transition: transform 0.3s ease;">
                                <path d="M7.41 8.58L12 13.17l4.59-4.59L18 10l-6 6-6-6 1.41-1.42z"/>
                            </svg>
                            ` : ''}
                        </div>
                        
                        <div id="${instanceId}-options" class="lang-expand-options" 
                            style="display: none; position: absolute; top: calc(100% + 10px); right: 0; min-width: 180px; background: #0f172a; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; overflow: hidden; z-index: 1000; box-shadow: 0 20px 40px rgba(0,0,0,0.5); padding: 6px;">
                            ${uniqueVariants.map(v => `
                                <div class="lang-opt ${v.id === currentBook.id ? 'active' : ''}" onclick="switchReaderLanguage('${v.id}')" 
                                    style="padding: 12px 16px; cursor: pointer; border-radius: 10px; transition: 0.2s; display: flex; align-items: center; gap: 10px; color: ${v.id === currentBook.id ? 'var(--color-accent)' : 'white'}; background: ${v.id === currentBook.id ? 'rgba(37, 99, 235, 0.1)' : 'transparent'};">
                                    <span style="font-size: 0.75rem; opacity: 0.5;">${(v.language || 'en').toUpperCase()}</span>
                                    <span style="font-size: 0.9rem; font-weight: ${v.id === currentBook.id ? '800' : '600'};">${getLangName(v.language)}</span>
                                    ${v.id === currentBook.id ? '<span style="margin-left: auto; font-size: 0.7rem;">‚úì</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            // Global click to close all
            document.removeEventListener('click', window.closeLangEvt);
            window.closeLangEvt = (e) => {
                if (!e.target.closest('.lang-expand-container')) {
                    document.querySelectorAll('.lang-expand-options').forEach(opt => {
                        opt.style.display = 'none';
                    });
                    document.querySelectorAll('.arrow-icon').forEach(arrow => {
                        arrow.style.transform = 'rotate(0deg)';
                    });
                }
            };
            document.addEventListener('click', window.closeLangEvt);
        };

        window.toggleLangOptions = function (e, instanceId) {
            e.stopPropagation();
            const options = document.getElementById(`${instanceId}-options`);
            if (!options) return;
            const isVisible = options.style.display === 'block';

            // Close others first
            document.querySelectorAll('.lang-expand-options').forEach(opt => {
                opt.style.display = 'none';
            });
            document.querySelectorAll('.arrow-icon').forEach(arrow => {
                arrow.style.transform = 'rotate(0deg)';
            });

            options.style.display = isVisible ? 'none' : 'block';
            const arrow = e.currentTarget.querySelector('.arrow-icon');
            if (arrow) arrow.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
        };

        window.switchReaderLanguage = function (newId) {
            if (!newId) return;
            const urlParams = new URLSearchParams(window.location.search);
            const ch = urlParams.get('ch') || '0';
            if (typeof showToast === 'function') showToast("Switching language...", "info");
            window.location.href = `reader.html?id=${newId}&ch=${ch}`;
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('id');
            const chapterIndex = parseInt(urlParams.get('ch') || '0');

            if (!bookId) {
                window.location.href = 'books.html';
                return;
            }

            // 1. Resolve Book & Current Chapter
            const cacheKey = `chapter_full_${bookId}_${chapterIndex}`;
            const navCacheKey = `book_nav_${bookId}`;

            // Try to get from cache first
            let book = CacheUtils.get(navCacheKey);
            let chapter = CacheUtils.get(cacheKey);

            // If either missing, fetch in parallel
            if (!book || !chapter) {
                const fetchPromises = [];

                if (!book) {
                    fetchPromises.push((async () => {
                        // Fetch from LocalStorage fallback if needed
                        let library = JSON.parse(localStorage.getItem('siteLibrary') || '[]');
                        let localBook = library.find(b => b.id === bookId);

                        if (typeof isSupabaseConfigured === 'function' && isSupabaseConfigured() && typeof isValidUUID === 'function' && isValidUUID(bookId)) {
                            try {
                                // üî• OPTIMIZATION: Try Edge Function First (Cached & Faster)
                                const edgeUrl = `${SUPABASE_URL}/functions/v1/get-book?id=${bookId}`;
                                const response = await fetch(edgeUrl, {
                                    headers: { 'apikey': SUPABASE_ANON_KEY }
                                }).catch(() => null);

                                if (response && response.ok) {
                                    const edgeData = await response.json();
                                    if (edgeData && edgeData.id) {
                                        book = edgeData;
                                        console.log("Reader: Book data loaded via Edge Function (Cached)");
                                    }
                                }

                                // Fallback to Direct Supabase Query if Edge Function failed
                                if (!book) {
                                    const { data: bookData } = await supabaseClient
                                        .from('books')
                                        .select('id, title, language, original_book_id')
                                        .eq('id', bookId)
                                        .single();

                                    if (bookData) {
                                        const { data: chaptersMetadata } = await supabaseClient
                                            .from('chapters')
                                            .select('id, title, chapter_number')
                                            .eq('book_id', bookId)
                                            .order('chapter_number', { ascending: true });

                                        book = {
                                            id: bookData.id,
                                            title: bookData.title,
                                            language: bookData.language,
                                            original_book_id: bookData.original_book_id,
                                            chapters: chaptersMetadata || []
                                        };
                                    }
                                }

                                if (book) {
                                    CacheUtils.set(navCacheKey, book, 10 * 60 * 1000); // 10 minute cache for nav
                                }
                            } catch (e) {
                                console.warn("Supabase book fetch failed", e);
                            }
                        }
                        return book || localBook;
                    })());
                }
                else {
                    fetchPromises.push(Promise.resolve(book));
                }

                if (!chapter) {
                    fetchPromises.push((async () => {
                        if (typeof isSupabaseConfigured === 'function' && isSupabaseConfigured() && typeof isValidUUID === 'function' && isValidUUID(bookId)) {
                            try {
                                // Fetch full content ONLY for the current chapter
                                const { data: chapterData } = await supabaseClient
                                    .from('chapters')
                                    .select('*')
                                    .eq('book_id', bookId)
                                    .eq('chapter_number', chapterIndex + 1)
                                    .single();

                                if (chapterData) {
                                    chapter = chapterData;
                                    CacheUtils.set(cacheKey, chapter, 60 * 1000); // 1 minute cache
                                }
                            } catch (e) {
                                console.warn("Supabase chapter fetch failed", e);
                            }
                        }
                        return chapter;
                    })());
                } else {
                    fetchPromises.push(Promise.resolve(chapter));
                }

                const results = await Promise.all(fetchPromises);
                book = results[0];
                chapter = results[1];
            }

            if (!chapter) {
                // Try fallback to local chapters if available in the book object
                if (book && book.chapters && book.chapters[chapterIndex] && book.chapters[chapterIndex].content) {
                    chapter = book.chapters[chapterIndex];
                } else {
                    await customAlert("Chapter not found!", "error");
                    window.location.href = 'books.html';
                    return;
                }
            }

            // Prefetch Next Chapter (Background)
            if (book && book.chapters && book.chapters[chapterIndex + 1]) {
                const nextChIdx = chapterIndex + 1;
                const nextCacheKey = `chapter_full_${bookId}_${nextChIdx}`;

                if (!CacheUtils.get(nextCacheKey)) {
                    CacheUtils.prefetchWithCache(nextCacheKey, async () => {
                        if (typeof isSupabaseConfigured === 'function' && isSupabaseConfigured() && typeof isValidUUID === 'function' && isValidUUID(bookId)) {
                            const { data } = await supabaseClient
                                .from('chapters')
                                .select('*')
                                .eq('book_id', bookId)
                                .eq('chapter_number', nextChIdx + 1)
                                .single();
                            return data;
                        }
                        return null;
                    }, 5 * 60 * 1000); // 5 min cache for prefetch
                }
            }

            // Update UI
            document.title = `${chapter.title} - ${book.title}`;
            document.getElementById('book-title-main').textContent = book.title;

            // Render Language Selector
            console.log("Calling renderLanguageSelector with book:", book);
            if (typeof window.renderLanguageSelector === 'function') {
                window.renderLanguageSelector(book);
            }

            // Apply Background Image if exists
            const bgUrl = chapter.backgroundImage || chapter.background_image;
            if (bgUrl) {
                document.body.style.setProperty('--custom-bg-url', `url('${window.getSupabaseImageUrl(bgUrl)}')`);
                document.body.classList.add('has-custom-bg');

                if (chapter.backgroundOverlay) {
                    document.body.style.setProperty('--custom-bg-overlay', chapter.backgroundOverlay);
                } else {
                    document.body.style.setProperty('--custom-bg-overlay', 'linear-gradient(to bottom, rgba(6, 11, 25, 0.4), rgba(6, 11, 25, 0.7))');
                }

                const bgStyle = chapter.backgroundStyle || chapter.background_style;
                if (bgStyle) {
                    document.body.style.setProperty('--custom-bg-size', bgStyle);
                }

                const readerContainer = document.querySelector('.reader-container');
                if (readerContainer) {
                    readerContainer.classList.add('has-custom-bg');
                }
            }

            // Apply Music if exists
            const audioEl = document.getElementById('bg-music');
            const musicBtnText = document.querySelector('.music-status-text');
            const musicUrl = chapter.musicUrl || chapter.audio_url;
            if (musicUrl) {
                audioEl.src = musicUrl;
                audioEl.volume = (chapter.musicVolume || chapter.music_volume || 30) / 100;
                audioEl.loop = (chapter.musicLoop !== undefined ? chapter.musicLoop : chapter.music_loop) !== false;
                musicBtnText.textContent = 'Music: Ready';
            }

            // Apply Custom CSS if exists
            if (chapter.customCss) {
                const styleTag = document.createElement('style');
                styleTag.textContent = chapter.customCss;
                document.head.appendChild(styleTag);
            }

            // Parse Title for Display
            let chNoLabel = `Chapter ${chapterIndex + 1}`;
            let chTitle = chapter.title;

            if (chapter.title.includes(':')) {
                const parts = chapter.title.split(':');
                chNoLabel = parts[0].trim();
                const remainder = parts[1].split('-');
                chTitle = remainder[0].trim();
            } else if (chapter.title.includes('-')) {
                const parts = chapter.title.split('-');
                chTitle = parts[0].trim();
            }

            document.getElementById('reading-ch-label').textContent = chNoLabel;
            document.getElementById('chapter-title-display').textContent = chTitle;

            // Use innerHTML to support Bold, Italic, and Headings
            const contentDisplay = document.getElementById('reader-content-display');
            const chapterContent = window.fixSupabaseImagesInHtml(chapter.content || "");

            // Sanitize HTML content before rendering (XSS Prevention)
            const cleanContent = typeof DOMPurify !== 'undefined' ?
                DOMPurify.sanitize(chapterContent) :
                chapterContent; // Fallback if library fails to load

            contentDisplay.innerHTML = cleanContent;

            // Apply formatting fixes (convert newlines to paragraphs if no HTML tags found)
            const hasHTML = /<p|<div|<h[1-6]|<img|<table|<ul|<ol|<blockquote/i.test(chapterContent);

            if (!hasHTML && chapterContent.trim()) {
                const paragraphs = chapterContent.split('\n\n');
                contentDisplay.innerHTML = paragraphs.map(p => {
                    const lineFixed = p.replace(/\n/g, '<br>');
                    return `<p>${lineFixed}</p>`;
                }).join('');
            } else if (chapterContent) {
                // If it has HTML, we trust the stored HTML
                contentDisplay.innerHTML = chapterContent;
            } else {
                contentDisplay.innerHTML = '<p style="text-align: center; opacity: 0.5; padding: 40px;">No content available for this chapter.</p>';
            }

            // --- PREFETCH NEXT CHAPTER ---
            if (book && book.chapters && chapterIndex < book.chapters.length - 1) {
                const nextIdx = chapterIndex + 1;
                const nextCacheKey = `chapter_full_${bookId}_${nextIdx}`;
                if (!CacheUtils.get(nextCacheKey)) {
                    setTimeout(async () => {
                        if (typeof isSupabaseConfigured === 'function' && isSupabaseConfigured() && typeof isValidUUID === 'function' && isValidUUID(bookId)) {
                            try {
                                const { data: nextChapter } = await supabaseClient
                                    .from('chapters')
                                    .select('*')
                                    .eq('book_id', bookId)
                                    .eq('chapter_number', nextIdx + 1)
                                    .single();
                                if (nextChapter) {
                                    CacheUtils.set(nextCacheKey, nextChapter, 24 * 60 * 60 * 1000);
                                    console.log(`Prefetched chapter ${nextIdx + 1}`);
                                }
                            } catch (e) {
                                console.warn("Prefetch failed", e);
                            }
                        }
                    }, 3000); // Wait 3 seconds before prefetching
                }
            }

            // Generate Chapter Tabs (Flat Navigation Style)
            const tabsContainer = document.getElementById('chapters-tabs-container');
            tabsContainer.innerHTML = '';
            book.chapters.forEach((ch, idx) => {
                const tab = document.createElement('a');
                tab.href = `reader.html?id=${bookId}&ch=${idx}`;
                tab.style.textDecoration = 'none';
                tab.style.padding = '15px 25px';
                tab.style.fontSize = '0.9rem';
                tab.style.fontWeight = '700';
                tab.style.transition = 'all 0.2s';
                tab.style.whiteSpace = 'nowrap';
                tab.style.fontFamily = 'var(--font-heading)';
                tab.style.display = 'block';
                tab.style.borderBottom = '2px solid transparent';
                tab.style.marginBottom = '-1px'; // Overlap with parent border

                // Title Extraction
                let tabTitle = ch.title;
                if (tabTitle.includes(':')) {
                    tabTitle = tabTitle.split(':')[1].trim();
                } else if (tabTitle.includes('-')) {
                    tabTitle = tabTitle.split('-')[0].trim();
                }
                tab.textContent = `${idx + 1}. ${tabTitle}`;

                if (idx === chapterIndex) {
                    tab.style.color = 'var(--color-accent)';
                    tab.style.borderBottomColor = 'var(--color-accent)';
                    tab.style.background = 'rgba(26, 115, 232, 0.05)';
                } else {
                    tab.style.color = '#94a3b8';
                }

                tab.onmouseover = () => {
                    if (idx !== chapterIndex) {
                        tab.style.color = '#fff';
                        tab.style.background = 'rgba(255,255,255,0.03)';
                    }
                };
                tab.onmouseout = () => {
                    if (idx !== chapterIndex) {
                        tab.style.color = '#94a3b8';
                        tab.style.background = 'transparent';
                    }
                };

                tabsContainer.appendChild(tab);
            });

            // Append Browse All Chapters Tab
            const browseTab = document.createElement('a');
            browseTab.href = 'books.html';
            browseTab.style.textDecoration = 'none';
            browseTab.style.padding = '15px 25px';
            browseTab.style.fontSize = '0.9rem';
            browseTab.style.fontWeight = '700';
            browseTab.style.color = '#fff';
            browseTab.style.background = 'var(--color-accent)';
            browseTab.style.borderRadius = '0 0 0 0';
            browseTab.style.display = 'block';
            browseTab.style.whiteSpace = 'nowrap';
            browseTab.style.fontFamily = 'var(--font-heading)';
            browseTab.textContent = 'Browse All Chapters';
            tabsContainer.appendChild(browseTab);

            // Sidebar Chapters (TOC)
            const sidebar = document.getElementById('sidebar-chapters');
            book.chapters.forEach((ch, idx) => {
                const link = document.createElement('a');
                link.href = `reader.html?id=${bookId}&ch=${idx}`;
                link.className = `sidebar-link ${idx === chapterIndex ? 'active' : ''}`;
                link.textContent = `${idx + 1}. ${ch.title}`;
                sidebar.appendChild(link);
            });

            // Append Browse All Chapters Sidebar Link
            const browseLink = document.createElement('a');
            browseLink.href = 'books.html';
            browseLink.className = 'sidebar-link';
            browseLink.style.color = 'var(--color-accent)';
            browseLink.style.fontWeight = '700';
            browseLink.style.marginTop = '10px';
            browseLink.style.borderTop = '1px solid rgba(255,255,255,0.05)';
            browseLink.style.paddingTop = '15px';
            browseLink.textContent = 'Browse All Chapters';
            sidebar.appendChild(browseLink);

            // Navigation
            const prevBtn = document.getElementById('prev-chapter');
            const nextBtn = document.getElementById('next-chapter');
            const prevBtnTop = document.getElementById('prev-btn-top');
            const nextBtnTop = document.getElementById('next-btn-top');

            if (chapterIndex > 0) {
                const prevUrl = `reader.html?id=${bookId}&ch=${chapterIndex - 1}`;
                prevBtn.href = prevUrl;
                prevBtnTop.href = prevUrl;
                document.getElementById('prev-title').textContent = book.chapters[chapterIndex - 1].title;
            } else {
                prevBtn.classList.add('disabled');
                prevBtnTop.style.opacity = '0.2';
                prevBtnTop.style.pointerEvents = 'none';
            }

            if (chapterIndex < book.chapters.length - 1) {
                const nextUrl = `reader.html?id=${bookId}&ch=${chapterIndex + 1}`;
                nextBtn.href = nextUrl;
                nextBtnTop.href = nextUrl;
                document.getElementById('next-title').textContent = book.chapters[chapterIndex + 1].title;
            } else {
                nextBtn.classList.add('disabled');
                nextBtnTop.style.opacity = '0.2';
                nextBtnTop.style.pointerEvents = 'none';
                document.getElementById('next-title').textContent = "End of Book";
            }

            // --- Initialize Interactions ---
            window.checkBookInteractions = async function (id) {
                // 1. Apply Local Cache Interactions Immediately
                const interactions = JSON.parse(localStorage.getItem('userInteractions') || '{}');
                const bookInter = interactions[id] || {};

                if (bookInter.reported) {
                    const btnReport = document.getElementById('btn-report-top');
                    if (btnReport) {
                        btnReport.style.color = '#ef4444';
                        btnReport.querySelector('span').textContent = 'Reported';
                    }
                }

                // Sync with Bookmark status
                const favs = JSON.parse(localStorage.getItem('userFavorites') || '[]');
                if (favs.includes(id)) {
                    document.getElementById('btn-save-top').classList.add('active');
                    if (document.getElementById('btn-save-bottom')) document.getElementById('btn-save-bottom').classList.add('active');
                }

                // 2. Sync with Supabase in background
                const ip = await window.getIpAddress();
                if (!ip || typeof supabaseClient === 'undefined') return;

                const { data } = await supabaseClient
                    .from('user_activity')
                    .select('activity_type')
                    .eq('ip_address', ip)
                    .eq('metadata->>book_id', id)
                    .in('activity_type', ['like_book', 'dislike_book']);

                if (data) {
                    let updated = false;
                    data.forEach(act => {
                        if (act.activity_type === 'like_book' && !bookInter.liked) {
                            bookInter.liked = true;
                            bookInter.disliked = false;
                            updated = true;
                        } else if (act.activity_type === 'dislike_book' && !bookInter.disliked) {
                            bookInter.disliked = true;
                            bookInter.liked = false;
                            updated = true;
                        }
                    });
                    if (updated) {
                        interactions[id] = bookInter;
                        localStorage.setItem('userInteractions', JSON.stringify(interactions));
                    }
                }
            }

            window.checkChapterInteractions = async function (bookId, chIndex) {
                // 1. Apply Local Cache Interactions Immediately
                const interactions = JSON.parse(localStorage.getItem('userInteractions') || '{}');
                if (!interactions[bookId]) interactions[bookId] = {};
                if (!interactions[bookId].chapters) interactions[bookId].chapters = {};

                const chInter = interactions[bookId].chapters[chIndex] || {};

                if (chInter.liked) {
                    if (document.getElementById('btn-like-top')) document.getElementById('btn-like-top').classList.add('active');
                    if (document.getElementById('btn-like-bottom')) document.getElementById('btn-like-bottom').classList.add('active');
                } else if (chInter.disliked) {
                    if (document.getElementById('btn-dislike-top')) document.getElementById('btn-dislike-top').classList.add('active');
                    if (document.getElementById('btn-dislike-bottom')) document.getElementById('btn-dislike-bottom').classList.add('active');
                }

                // 2. Sync with Supabase in background
                const ip = await window.getIpAddress();
                if (typeof supabaseClient === 'undefined') return;

                // Combined fetch: User interaction + Total counts
                const [userActRes, totalCountsRes] = await Promise.all([
                    ip ? supabaseClient
                        .from('user_activity')
                        .select('activity_type')
                        .eq('ip_address', ip)
                        .eq('metadata->>book_id', bookId)
                        .eq('metadata->>chapter_index', chIndex.toString())
                        .in('activity_type', ['like_chapter', 'dislike_chapter']) : Promise.resolve({ data: null }),

                    supabaseClient
                        .from('user_activity')
                        .select('activity_type')
                        .eq('metadata->>book_id', bookId)
                        .eq('metadata->>chapter_index', chIndex.toString())
                        .in('activity_type', ['like_chapter', 'dislike_chapter'])
                ]);

                // Update Total counts UI
                if (totalCountsRes.data) {
                    const likes = totalCountsRes.data.filter(a => a.activity_type === 'like_chapter').length;
                    const dislikes = totalCountsRes.data.filter(a => a.activity_type === 'dislike_chapter').length;

                    window.updateChapterCountsUI(likes, dislikes);
                }

                const data = userActRes.data;
                if (data) {
                    let updated = false;
                    data.forEach(act => {
                        if (act.activity_type === 'like_chapter' && !chInter.liked) {
                            chInter.liked = true;
                            chInter.disliked = false;
                            updated = true;
                        } else if (act.activity_type === 'dislike_chapter' && !chInter.disliked) {
                            chInter.disliked = true;
                            chInter.liked = false;
                            updated = true;
                        }
                    });
                    if (updated) {
                        interactions[bookId].chapters[chIndex] = chInter;
                        localStorage.setItem('userInteractions', JSON.stringify(interactions));
                        // Re-apply styles if updated
                        if (chInter.liked) {
                            if (document.getElementById('btn-like-top')) document.getElementById('btn-like-top').classList.add('active');
                            if (document.getElementById('btn-like-bottom')) document.getElementById('btn-like-bottom').classList.add('active');
                            if (document.getElementById('btn-dislike-top')) document.getElementById('btn-dislike-top').classList.remove('active');
                            if (document.getElementById('btn-dislike-bottom')) document.getElementById('btn-dislike-bottom').classList.remove('active');
                        } else if (chInter.disliked) {
                            if (document.getElementById('btn-dislike-top')) document.getElementById('btn-dislike-top').classList.add('active');
                            if (document.getElementById('btn-dislike-bottom')) document.getElementById('btn-dislike-bottom').classList.add('active');
                            if (document.getElementById('btn-like-top')) document.getElementById('btn-like-top').classList.remove('active');
                            if (document.getElementById('btn-like-bottom')) document.getElementById('btn-like-bottom').classList.remove('active');
                        }
                    }
                }
            }

            window.updateChapterCountsUI = function (likes, dislikes) {
                const els = {
                    likeTop: document.getElementById('count-like-top'),
                    likeBottom: document.getElementById('count-like-bottom'),
                    dislikeTop: document.getElementById('count-dislike-top'),
                    dislikeBottom: document.getElementById('count-dislike-bottom')
                };

                if (els.likeTop) els.likeTop.textContent = likes;
                if (els.likeBottom) els.likeBottom.textContent = likes;
                if (els.dislikeTop) els.dislikeTop.textContent = dislikes;
                if (els.dislikeBottom) els.dislikeBottom.textContent = dislikes;
            }

            window.getIpAddress = async function () {
                try {
                    let ip = sessionStorage.getItem('user_ip');
                    if (ip) return ip;
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    ip = data.ip;
                    sessionStorage.setItem('user_ip', ip);
                    return ip;
                } catch (e) {
                    console.warn("Could not get IP", e);
                    return null;
                }
            }

            if (typeof window.checkBookInteractions === 'function') window.checkBookInteractions(bookId);
            if (typeof window.checkChapterInteractions === 'function') window.checkChapterInteractions(bookId, chapterIndex);



            window.toggleChapterLike = async function () {
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id');
                const chIndex = urlParams.get('ch') || '0';

                const btnTop = document.getElementById('btn-like-top');
                const btnBottom = document.getElementById('btn-like-bottom');
                const btnDisTop = document.getElementById('btn-dislike-top');
                const btnDisBottom = document.getElementById('btn-dislike-bottom');

                const ip = await window.getIpAddress();

                if (!ip || !id) return;

                const interactions = JSON.parse(localStorage.getItem('userInteractions') || '{}');
                if (!interactions[id]) interactions[id] = {};
                if (!interactions[id].chapters) interactions[id].chapters = {};
                if (!interactions[id].chapters[chIndex]) interactions[id].chapters[chIndex] = {};

                const isActive = interactions[id].chapters[chIndex].liked === true;

                try {
                    const likeEls = [document.getElementById('count-like-top'), document.getElementById('count-like-bottom')];
                    const disLabels = [document.getElementById('count-dislike-top'), document.getElementById('count-dislike-bottom')];

                    if (isActive) {
                        await supabaseClient.from('user_activity').delete()
                            .eq('ip_address', ip).eq('metadata->>book_id', id)
                            .eq('metadata->>chapter_index', chIndex.toString()).eq('activity_type', 'like_chapter');

                        if (btnTop) btnTop.classList.remove('active');
                        if (btnBottom) btnBottom.classList.remove('active');
                        interactions[id].chapters[chIndex].liked = false;

                        // Local decrement
                        likeEls.forEach(el => { if (el) el.textContent = Math.max(0, parseInt(el.textContent || '0') - 1); });
                    } else {
                        await supabaseClient.from('user_activity').delete()
                            .eq('ip_address', ip).eq('metadata->>book_id', id)
                            .eq('metadata->>chapter_index', chIndex.toString()).eq('activity_type', 'dislike_chapter');

                        if (btnDisTop) {
                            if (btnDisTop.classList.contains('active')) {
                                disLabels.forEach(el => { if (el) el.textContent = Math.max(0, parseInt(el.textContent || '0') - 1); });
                            }
                            btnDisTop.classList.remove('active');
                        }
                        if (btnDisBottom) btnDisBottom.classList.remove('active');
                        interactions[id].chapters[chIndex].disliked = false;

                        await supabaseClient.from('user_activity').insert([{
                            ip_address: ip,
                            activity_type: 'like_chapter',
                            metadata: { book_id: id, chapter_index: chIndex.toString() },
                            page_url: window.location.href
                        }]);

                        if (btnTop) btnTop.classList.add('active');
                        if (btnBottom) btnBottom.classList.add('active');
                        interactions[id].chapters[chIndex].liked = true;

                        // Local increment
                        likeEls.forEach(el => { if (el) el.textContent = parseInt(el.textContent || '0') + 1; });
                    }
                    localStorage.setItem('userInteractions', JSON.stringify(interactions));
                } catch (e) { console.error(e); }
            }

            window.toggleChapterDislike = async function () {
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id');
                const chIndex = urlParams.get('ch') || '0';

                const btnTop = document.getElementById('btn-dislike-top');
                const btnBottom = document.getElementById('btn-dislike-bottom');
                const btnLikeTop = document.getElementById('btn-like-top');
                const btnLikeBottom = document.getElementById('btn-like-bottom');

                const ip = await window.getIpAddress();

                if (!ip || !id) return;

                const interactions = JSON.parse(localStorage.getItem('userInteractions') || '{}');
                if (!interactions[id]) interactions[id] = {};
                if (!interactions[id].chapters) interactions[id].chapters = {};
                if (!interactions[id].chapters[chIndex]) interactions[id].chapters[chIndex] = {};

                const isActive = interactions[id].chapters[chIndex].disliked === true;

                try {
                    const disEls = [document.getElementById('count-dislike-top'), document.getElementById('count-dislike-bottom')];
                    const likeEls = [document.getElementById('count-like-top'), document.getElementById('count-like-bottom')];

                    if (isActive) {
                        await supabaseClient.from('user_activity').delete()
                            .eq('ip_address', ip).eq('metadata->>book_id', id)
                            .eq('metadata->>chapter_index', chIndex.toString()).eq('activity_type', 'dislike_chapter');

                        if (btnTop) btnTop.classList.remove('active');
                        if (btnBottom) btnBottom.classList.remove('active');
                        interactions[id].chapters[chIndex].disliked = false;

                        // Local decrement
                        disEls.forEach(el => { if (el) el.textContent = Math.max(0, parseInt(el.textContent || '0') - 1); });
                    } else {
                        await supabaseClient.from('user_activity').delete()
                            .eq('ip_address', ip).eq('metadata->>book_id', id)
                            .eq('metadata->>chapter_index', chIndex.toString()).eq('activity_type', 'like_chapter');

                        if (btnLikeTop) {
                            if (btnLikeTop.classList.contains('active')) {
                                likeEls.forEach(el => { if (el) el.textContent = Math.max(0, parseInt(el.textContent || '0') - 1); });
                            }
                            btnLikeTop.classList.remove('active');
                        }
                        if (btnLikeBottom) btnLikeBottom.classList.remove('active');
                        interactions[id].chapters[chIndex].liked = false;

                        await supabaseClient.from('user_activity').insert([{
                            ip_address: ip,
                            activity_type: 'dislike_chapter',
                            metadata: { book_id: id, chapter_index: chIndex.toString() },
                            page_url: window.location.href
                        }]);

                        if (btnTop) btnTop.classList.add('active');
                        if (btnBottom) btnBottom.classList.add('active');
                        interactions[id].chapters[chIndex].disliked = true;

                        // Local increment
                        disEls.forEach(el => { if (el) el.textContent = parseInt(el.textContent || '0') + 1; });
                    }
                    localStorage.setItem('userInteractions', JSON.stringify(interactions));
                } catch (e) { console.error(e); }
            }

            window.toggleSaveReader = function () {
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id');
                if (!id) return;

                let favs = JSON.parse(localStorage.getItem('userFavorites') || '[]');
                const btnTop = document.getElementById('btn-save-top');
                const btnBottom = document.getElementById('btn-save-bottom');

                if (favs.includes(id)) {
                    favs = favs.filter(fid => fid !== id);
                    if (btnTop) btnTop.classList.remove('active');
                    if (btnBottom) btnBottom.classList.remove('active');
                    showToast("Removed from favorites", "info");
                } else {
                    favs.push(id);
                    if (btnTop) btnTop.classList.add('active');
                    if (btnBottom) btnBottom.classList.add('active');
                    showToast("Added to favorites", "success");
                }
                localStorage.setItem('userFavorites', JSON.stringify(favs));
            }

            window.jumpToCommentsReader = function () {
                const modal = document.getElementById('chapter-review-modal');
                if (modal) {
                    modal.style.display = 'flex';

                    // Set chapter title
                    const chapterTitle = document.getElementById('chapter-title-display').textContent;
                    document.getElementById('chapter-review-title').textContent = chapterTitle;

                    // Reset form
                    document.getElementById('chapter-review-name').value = '';
                    document.getElementById('chapter-review-comment').value = '';

                    // Reset rating
                    const stars = document.querySelectorAll('#chapter-rating-stars .star-box');
                    stars.forEach(star => star.classList.remove('active'));
                    window.currentChapterRating = 0;
                }
            }

            window.setChapterRating = function (rating) {
                window.currentChapterRating = rating;
                const stars = document.querySelectorAll('#chapter-rating-stars .star-box');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('active');
                        star.style.color = '#fbbf24';
                    } else {
                        star.classList.remove('active');
                        star.style.color = '#475569';
                    }
                });
            }

            window.closeChapterReviewModal = function () {
                const modal = document.getElementById('chapter-review-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            async function getIpAddress() {
                try {
                    let ip = sessionStorage.getItem('user_ip');
                    if (ip) return ip;
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    let fetchedIp = data.ip;
                    sessionStorage.setItem('user_ip', fetchedIp);
                    return fetchedIp;
                } catch (e) {
                    console.warn("Could not get IP", e);
                    return '0.0.0.0'; // Fallback
                }
            }

            window.submitChapterReview = async function () {
                const urlParams = new URLSearchParams(window.location.search);
                const bookId = urlParams.get('id');
                const chapterIndex = urlParams.get('ch') || '0';

                const name = document.getElementById('chapter-review-name').value.trim();
                const comment = document.getElementById('chapter-review-comment').value.trim();
                const rating = window.currentChapterRating || 0;
                const chapterTitle = document.getElementById('chapter-title-display').textContent;
                const bookTitle = document.getElementById('book-title-main').textContent;

                if (!name) {
                    customAlert('Please enter your name.', 'warning', 'Name Required');
                    return;
                }

                if (rating === 0) {
                    customAlert('Please select a rating.', 'warning', 'Rating Required');
                    return;
                }

                if (!comment) {
                    customAlert('Please write a review.', 'warning', 'Review Required');
                    return;
                }

                try {
                    if (typeof isSupabaseConfigured !== 'function' || !isSupabaseConfigured()) {
                        customAlert('Cloud sync is required to submit reviews.', 'error', 'Supabase Not Configured');
                        return;
                    }

                    // Resolve book UUID
                    let targetUuid = bookId;
                    const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(bookId);

                    if (!isUuid) {
                        const { data: bookRef } = await supabaseClient.from('books').select('id').eq('title', bookTitle).single();
                        if (!bookRef) {
                            customAlert('This book needs to be synced with the cloud before reviews can be submitted.', 'error', 'Book Not Found');
                            return;
                        }
                        targetUuid = bookRef.id;
                    }

                    const ip = await window.getIpAddress();

                    // Submit review to book_reviews table with chapter information
                    const { error } = await supabaseClient.from('book_reviews').insert([{
                        book_id: targetUuid,
                        reviewer_name: name,
                        rating: rating,
                        comment: comment,
                        ip_address: ip,
                        chapter_number: parseInt(chapterIndex) + 1,
                        chapter_title: chapterTitle
                    }]);

                    if (error) throw error;

                    customAlert('Your chapter review has been submitted successfully! It will appear in the book\'s review tab.', 'success', 'Review Submitted');
                    closeChapterReviewModal();

                } catch (err) {
                    console.error('Review submission error:', err);
                    customAlert('Failed to submit review. Please try again.', 'error', 'Submission Failed');
                }
            }


            window.shareBookReader = function () {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    showToast("Link copied to clipboard!", "success");
                });
            }

            window.toggleReportReader = function () {
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id');
                if (!id) return;

                let interactions = JSON.parse(localStorage.getItem('userInteractions') || '{}');
                if (!interactions[id]) interactions[id] = {};

                const btn = document.getElementById('btn-report-top');

                if (interactions[id].reported) {
                    delete interactions[id].reported;
                    if (btn) {
                        btn.style.color = '';
                        btn.querySelector('span').textContent = 'Report';
                    }
                    localStorage.setItem('userInteractions', JSON.stringify(interactions));
                } else {
                    customConfirm('Are you sure you want to report this book for content issues?', 'Report Content', '‚ö†Ô∏è').then(confirmed => {
                        if (confirmed) {
                            interactions[id].reported = true;
                            if (btn) {
                                btn.style.color = '#ef4444';
                                btn.querySelector('span').textContent = 'Reported';
                            }
                            localStorage.setItem('userInteractions', JSON.stringify(interactions));
                            customAlert('Thank you for your report. We will review it shortly.', 'success', 'Report Submitted');
                        }
                    });
                }
            }

            if (typeof window.checkBookInteractions === 'function') window.checkBookInteractions(bookId);
            if (typeof window.checkChapterInteractions === 'function') window.checkChapterInteractions(bookId, chapterIndex);

            window.scrollTo(0, 0);

        });

        // Background Music Control
        const audio = document.getElementById('bg-music');
        const musicBtn = document.getElementById('music-toggle');
        const musicStatus = musicBtn.querySelector('.music-status-text');

        function toggleMusic() {
            if (audio.paused) {
                audio.play().then(() => {
                    musicBtn.classList.add('playing');
                    musicStatus.textContent = 'Music: Playing';
                }).catch(err => {
                    showToast("Click anywhere on the page first to enable audio playing.", "info");
                });
            } else {
                audio.pause();
                musicBtn.classList.remove('playing');
                musicStatus.textContent = 'Music: Paused';
            }
        }

        window.updateReaderStats = async function (bookId) {
            if (!bookId) return;

            const readsEl = document.getElementById('reader-reads-count');
            const ratingEl = document.getElementById('reader-rating-display');

            if (typeof isSupabaseConfigured !== 'function' || !isSupabaseConfigured() || !window.supabaseClient) return;

            // Prevent 400 Bad Request for legacy numeric IDs
            if (typeof isValidUUID === 'function' && !isValidUUID(bookId)) {
                console.warn("Skipping reader stats update for legacy ID:", bookId);
                if (readsEl) readsEl.innerHTML = 'üëÅÔ∏è 0 Reads';
                if (ratingEl) ratingEl.innerHTML = '‚≠ê -- Rating';
                return;
            }

            try {
                // Parallel fetch for valid data + fallbacks
                const [viewsRes, reviewsRes, bookRes] = await Promise.all([
                    // 1. Reads Count
                    supabaseClient
                        .from('user_activity')
                        .select('id', { count: 'exact', head: true })
                        .contains('metadata', { book_id: bookId })
                        .eq('activity_type', 'page_view'),

                    // 2. Reviews Average
                    supabaseClient
                        .from('book_reviews')
                        .select('rating')
                        .eq('book_id', bookId),

                    // 3. Book Metadata (for fallback rating)
                    supabaseClient
                        .from('books')
                        .select('detail_settings, rating')
                        .eq('id', bookId)
                        .maybeSingle()
                ]);

                // Update Reads
                if (readsEl) {
                    const count = viewsRes.count || 0;
                    readsEl.innerHTML = `üëÅÔ∏è ${count.toLocaleString()} Reads`;
                }

                // Update Rating
                if (ratingEl) {
                    let finalRating = null;
                    let ratingSource = 'none';

                    // Priority 1: Real Reviews
                    if (reviewsRes.data && reviewsRes.data.length > 0) {
                        const total = reviewsRes.data.reduce((sum, r) => sum + r.rating, 0);
                        finalRating = (total / reviewsRes.data.length).toFixed(1);
                        ratingSource = 'reviews';
                    }

                    // Priority 2: Admin Manual Setting (detail_settings)
                    if (!finalRating && bookRes.data?.detail_settings) {
                        const ds = bookRes.data.detail_settings;
                        // Check widely used keys
                        const raw = ds.rating || (ds.stats && ds.stats.rating) || ds.detailRating;

                        if (raw) {
                            const match = String(raw).match(/[\d.]+/);
                            if (match) {
                                finalRating = match[0];
                                ratingSource = 'admin';
                            }
                        }
                    }

                    // Priority 3: Book Table Column
                    if (!finalRating && bookRes.data?.rating) {
                        finalRating = bookRes.data.rating;
                        ratingSource = 'column';
                    }

                    // Final Display
                    if (finalRating) {
                        ratingEl.innerHTML = `‚≠ê ${finalRating} Rating`;
                    } else {
                        ratingEl.innerHTML = `‚≠ê -- Rating`; // Truly no data
                    }
                }

            } catch (e) {
                console.warn("Failed to update reader stats", e);
                // Safe fallback
                if (readsEl && readsEl.innerHTML.includes('--')) readsEl.innerHTML = 'üëÅÔ∏è 0 Reads';
            }
        }


        // Call stats update
        if (typeof isSupabaseConfigured === 'function' && isSupabaseConfigured()) {
            const urlParamsForStats = new URLSearchParams(window.location.search);
            const statsBookId = urlParamsForStats.get('id');
            const statsChIdx = urlParamsForStats.get('ch') || '0';

            updateReaderStats(statsBookId);
            // Log local page view with metadata for accurate counting
            if (typeof logActivity === 'function') {
                logActivity('page_view', { book_id: statsBookId, chapter_index: statsChIdx });
            }
        }

        // Auto-pause if user leaves tab
        document.addEventListener('visibilitychange', () => {
            const audio = document.getElementById('bg-music');
            const musicBtn = document.getElementById('music-toggle');
            const musicStatus = musicBtn ? musicBtn.querySelector('.music-status-text') : null;
            if (document.hidden && audio && !audio.paused) {
                audio.pause();
                if (musicBtn) musicBtn.classList.remove('playing');
                if (musicStatus) musicStatus.textContent = 'Music: OFF';
            }
        });

        // --- Tracking Logic ---
        // 1. Scroll Depth for Chapter Reads
        let hasTrackedRead = false;
        window.addEventListener('scroll', () => {
            if (hasTrackedRead) return;
            const scrollPercent = (window.innerHeight + window.scrollY) / document.body.offsetHeight;
            if (scrollPercent > 0.8) {
                hasTrackedRead = true;
                const urlParams = new URLSearchParams(window.location.search);
                const bookId = urlParams.get('id');
                const chIdx = urlParams.get('ch') || '0';
                if (bookId && window.trackChapterRead) {
                    window.trackChapterRead(bookId, chIdx, 0); // 0 for time (can be improved)
                }
            }
        });

        // 2. Ad Click Tracking
        document.addEventListener('click', (e) => {
            const adContainer = e.target.closest('.ad-container, .vertical-ad-banner');
            if (adContainer && window.trackAdClick) {
                const isVertical = adContainer.classList.contains('vertical-ad-banner');
                const location = isVertical ? 'sidebar' : (adContainer.classList.contains('ad-middle') ? 'content_middle' : 'footer');
                window.trackAdClick('generic_ad_unit', location);
            }
        });

    </script>


    <!-- Custom Modal HTML -->
    <div id="alert-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px; text-align: center; padding: 30px;">
            <div id="alert-icon" style="font-size: 3rem; margin-bottom: 20px;">‚ÑπÔ∏è</div>
            <h3 id="alert-title" style="margin: 0 0 10px 0; color: #fff;">Notice</h3>
            <p id="alert-message" style="color: #94a3b8; font-size: 0.95rem; line-height: 1.5; margin-bottom: 25px;">
                This is an alert message.</p>
            <div style="display: flex; justify-content: center;">
                <button id="alert-ok-btn" class="btn-primary"
                    style="background: #3b82f6; margin: 0; min-width: 120px;">OK</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px; text-align: center; padding: 30px;">
            <div id="confirm-icon" style="font-size: 3rem; margin-bottom: 20px;">‚ö†Ô∏è</div>
            <h3 id="confirm-title" style="margin: 0 0 10px 0; color: #fff;">Are you sure?</h3>
            <p id="confirm-message" style="color: #94a3b8; font-size: 0.95rem; line-height: 1.5; margin-bottom: 25px;">
                This action cannot be undone.</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="confirm-cancel-btn" class="btn-primary"
                    style="background: #334155; margin: 0; flex: 1;">Cancel</button>
                <button id="confirm-ok-btn" class="btn-success"
                    style="background: #ef4444; margin: 0; flex: 1;">Confirm</button>
            </div>
        </div>
    </div>
</body>

</html>